# üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `flutter_background_service` –≤ `pubspec.yaml`
2. ‚úÖ –°–æ–∑–¥–∞–Ω `BackgroundLocationService` –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
3. ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `AndroidManifest.xml` —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω foreground service –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é

–í–æ–¥–∏—Ç–µ–ª—å –æ–¥–∏–Ω —Ä–∞–∑ –≤—Ö–æ–¥–∏—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –¥–∞—ë—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ:

1. **–§–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤–æ–¥–∏—Ç–µ–ª—è
2. **–†–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é**: 7:00 - 17:00, –∫—Ä–æ–º–µ –ø—è—Ç–Ω–∏—Ü—ã –∏ —Å—É–±–±–æ—Ç—ã
3. **–û–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É** –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è
4. **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** "–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ"
5. **–†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ**

### –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

#### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã

```bash
flutter pub get
```

#### 2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ driver_dashboard.dart

–î–æ–±–∞–≤–∏—Ç—å –≤ `_DriverDashboardState`:

```dart
import '../services/background_location_service.dart';

@override
void initState() {
  super.initState();
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å
  _initializeBackgroundService();
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}

Future<void> _initializeBackgroundService() async {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å
  await BackgroundLocationService.initialize();
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω
  final isRunning = await BackgroundLocationService.isRunning();
  if (!isRunning) {
    final authService = context.read<AuthService>();
    final driverId = authService.currentUser!.uid;
    final driverName = authService.userModel?.name ?? '–í–æ–¥–∏—Ç–µ–ª—å';
    
    await BackgroundLocationService.start(driverId, driverName);
    debugPrint('‚úÖ [Driver] Background tracking started');
  }
}
```

#### 3. –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ UI (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```dart
// –í AppBar –∏–ª–∏ –≤ body
IconButton(
  icon: Icon(_isBackgroundTrackingActive ? Icons.gps_fixed : Icons.gps_off),
  onPressed: () async {
    if (_isBackgroundTrackingActive) {
      await BackgroundLocationService.stop();
      setState(() => _isBackgroundTrackingActive = false);
    } else {
      final authService = context.read<AuthService>();
      await BackgroundLocationService.start(
        authService.currentUser!.uid,
        authService.userModel?.name ?? '–í–æ–¥–∏—Ç–µ–ª—å',
      );
      setState(() => _isBackgroundTrackingActive = true);
    }
  },
  tooltip: '–§–æ–Ω–æ–≤–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ',
)
```

#### 4. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å APK

```bash
flutter build apk --release
```

## –ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è

1. –í–æ–¥–∏—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–≤–∫–ª—é—á–∞—è —Ñ–æ–Ω–æ–≤–æ–µ)
3. –í–æ–¥–∏—Ç–µ–ª—å –¥–∞—ë—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
4. –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "LogiRoute - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ"
5. –í–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
6. –í –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–ù–µ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∫—Ä—ã—Ç–æ)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è –±–∞—Ç–∞—Ä–µ–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É, —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è)
- ‚úÖ –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (Android –Ω–µ —É–±—å—ë—Ç —Å–µ—Ä–≤–∏—Å)
- ‚úÖ –î–∏—Å–ø–µ—Ç—á–µ—Ä –≤–∏–¥–∏—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π –Ω–∞ –∫–∞—Ä—Ç–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

```dart
// –†–∞–±–æ—á–∏–µ —á–∞—Å—ã: 7:00 - 17:00
// –í—ã—Ö–æ–¥–Ω—ã–µ: –ü—è—Ç–Ω–∏—Ü–∞ (5), –°—É–±–±–æ—Ç–∞ (6)
static bool _isWorkTime(DateTime time) {
  if (time.weekday == 5 || time.weekday == 6) {
    return false;
  }
  final hour = time.hour;
  return hour >= 7 && hour < 17;
}
```

### –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

- **–í —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è**: –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- **–í–Ω–µ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏**: –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (—ç–∫–æ–Ω–æ–º–∏—è –±–∞—Ç–∞—Ä–µ–∏)

### –¢–æ—á–Ω–æ—Å—Ç—å GPS

- `LocationAccuracy.high` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

### –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Firestore:
```
/driver_locations/{driverId}
  - driverId: string
  - driverName: string
  - latitude: double
  - longitude: double
  - timestamp: Timestamp
  - accuracy: double
  - speed: double
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `flutter pub get`
2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `driver_dashboard.dart`
3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å APK
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

## –í–∞–∂–Ω–æ!

- –§–æ–Ω–æ–≤–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ **—Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö** (–Ω–µ –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ)
- –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ `ACCESS_BACKGROUND_LOCATION` (Android 10+)
- Foreground service –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–Ω–µ–ª—å–∑—è —É–±—Ä–∞—Ç—å)
