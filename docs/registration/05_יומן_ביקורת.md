# יומן ביקורת (Audit Log)

## עקרון מנחה

כל פעולה משמעותית במערכת נרשמת ביומן ביקורת **לפני** ביצוע הפעולה עצמה
(log-before-action). היומן הוא append-only — לא ניתן לעדכן או למחוק רשומות.

## סוגי אירועים

| סוג | קוד | תיאור |
|------|------|--------|
| יצירה | `created` | מסמך נוצר |
| סיום | `finalized` | מסמך עבר סיום (immutable) |
| הדפסה | `printed` | מסמך הודפס |
| ייצוא | `exported` | מסמך יוצא |
| ביטול | `cancelled` | מסמך בוטל |
| זיכוי | `creditNoteCreated` | נוצר מסמך זיכוי |
| שינוי סטטוס | `statusChanged` | סטטוס שונה |
| עדכון טכני | `technicalUpdate` | עדכון שדה טכני |

## מבנה רשומת ביקורת

```json
{
  "entityId": "מזהה המסמך",
  "entityType": "סוג המסמך (invoice/creditNote/receipt/delivery)",
  "companyId": "מזהה החברה",
  "eventType": "סוג האירוע",
  "timestamp": "חותמת זמן שרת (FieldValue.serverTimestamp)",
  "actorUid": "UID המשתמש המבצע",
  "actorName": "שם המשתמש (אופציונלי)",
  "requestId": "מזהה ייחודי לבקשה (UUID)",
  "metadata": {
    "// מטא-נתונים נוספים לפי סוג האירוע"
  }
}
```

## אחסון

- אוסף: `companies/{companyId}/invoices/{invoiceId}/auditLog/{eventId}`
- תת-אוסף של המסמך — מאפשר שאילתות יעילות
- חותמת זמן: `FieldValue.serverTimestamp()` — לא ניתנת לזיוף

### שלמות שעון (Clock Integrity)
- **כל חותמות הזמן נקבעות בצד השרת** — `FieldValue.serverTimestamp()`
- שעון הלקוח **לא משפיע** על חותמות הזמן ביומן הביקורת
- גם אם לקוח ישנה את השעון המקומי — חותמת הזמן בשרת תהיה נכונה
- Google Cloud Firestore משתמש בשעון NTP מסונכרן עם דיוק של מילישניות

## Firestore Security Rules

```javascript
match /auditLog/{eventId} {
  // קריאה: משתמשי החברה + super_admin
  allow read: if request.auth != null && (
    userRole == 'super_admin' || userCompanyId == companyId
  );
  // יצירה: append-only, actorUid == auth.uid
  allow create: if request.auth != null && (
    userRole == 'super_admin' || userCompanyId == companyId
  ) && request.resource.data.actorUid == request.auth.uid;
  // עדכון ומחיקה — אסורים
  allow update: if false;
  allow delete: if false;
}
```

## דוגמאות אירועים

### יצירת חשבונית
```json
{
  "eventType": "created",
  "actorUid": "user123",
  "metadata": { "sequentialNumber": 42 }
}
```

### הדפסת מקור
```json
{
  "eventType": "printed",
  "actorUid": "user123",
  "metadata": {
    "copyType": "original",
    "copies": 3,
    "isFirstPrint": true
  }
}
```

### ביטול חשבונית
```json
{
  "eventType": "cancelled",
  "actorUid": "user123",
  "metadata": { "reason": "טעות בפרטי הלקוח" }
}
```

### אישור מספר הקצאה
```json
{
  "eventType": "statusChanged",
  "actorUid": "system",
  "metadata": {
    "action": "assignment_approved",
    "assignmentNumber": "1234567890"
  }
}
```

## יומן גישה (Access Log)

בנוסף ליומן ביקורת של מסמכים, המערכת מתעדת גישות:
- אוסף: `companies/{companyId}/access_log/{logId}`
- אירועים: כניסה, יציאה, צפייה במסמך, הדפסה, ייצוא
- append-only
- `actorUid == auth.uid` (Firestore Rules)

## ממשק משתמש

- מסך "היסטוריה" לכל מסמך — צפייה בכל אירועי הביקורת
- אייקונים וצבעים לפי סוג אירוע
- תצוגת מטא-נתונים בלחיצה
- סינון לפי סוג אירוע ותאריך
