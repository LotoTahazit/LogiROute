# חשבוניות ישראל — מספר הקצאה

## תיאור

המערכת תומכת בפורטל "חשבוניות ישראל" של רשות המסים.
עבור חשבוניות מס מעל הסף הנדרש — המערכת מבקשת מספר הקצאה אוטומטית.

## ספי חובה (סכום לפני מע"מ)

| תאריך | סף |
|--------|------|
| עד 31.12.2025 | 20,000 ₪ |
| מ-01.01.2026 | 10,000 ₪ |
| מ-01.06.2026 | 5,000 ₪ |

## סטטוסים

| סטטוס | קוד | תיאור |
|--------|------|--------|
| לא נדרש | `notRequired` | סכום מתחת לסף |
| ממתין | `pending` | בקשה נשלחה — ממתין לתשובה |
| אושר | `approved` | מספר הקצאה התקבל |
| נדחה | `rejected` | סירוב מרשות המסים |
| שגיאה | `error` | שגיאה טכנית |

## שדות במסמך

| שדה | סוג | תיאור |
|------|------|--------|
| assignmentNumber | String? | מספר הקצאה שהתקבל |
| assignmentStatus | Enum | סטטוס הבקשה |
| assignmentRequestedAt | DateTime? | מתי נשלחה הבקשה |
| assignmentResponseRaw | String? | תשובה גולמית מה-API |

## תהליך

### 1. סיום מסמך (Finalization)
- לאחר סיום — המערכת בודקת אם הסכום מעל הסף
- אם כן — נשלחת בקשת מספר הקצאה אוטומטית

### 2. בקשת מספר הקצאה
- **דדופליקציה**: אם כבר אושר או ממתין — לא נשלחת בקשה חדשה
- **בדיקת סף**: אם מתחת לסף — סטטוס `notRequired`
- **סימון**: סטטוס `pending` + חותמת זמן
- **רישום**: בקשה נרשמת ב-`companies/{cId}/assignment_requests/{reqId}`

### 3. שליחה ל-API
- Exponential backoff: עד 3 ניסיונות (2s, 4s, 8s)
- Timeout: 30 שניות לכל ניסיון
- נתונים נשלחים: מספר חשבונית, מספר עוסק, סכום לפני מע"מ, סכום מע"מ

### 4. טיפול בתשובה
- **אישור**: עדכון `assignmentNumber` + `assignmentStatus: approved`
- **סירוב**: עדכון `assignmentStatus: rejected` + רישום ביומן ביקורת
- **שגיאה**: עדכון `assignmentStatus: error` + רישום ביומן ביקורת

### 5. ניסיון חוזר ידני (Manual Retry)
- אם הבקשה נכשלה (שגיאה טכנית או סירוב) — המשתמש יכול לבקש מספר הקצאה מחדש
- הסטטוס משתנה ל-`pending` ותהליך הבקשה מתחיל מחדש
- כל ניסיון נרשם ב-`assignment_requests` — היסטוריה מלאה של כל הבקשות

## חסימת הדפסה

- **חשבוניות מעל הסף**: הדפסת מקור חסומה עד קבלת מספר הקצאה
- בדיקה: `invoice.requiresAssignment && assignmentStatus != approved`
- הודעה למשתמש: "לא ניתן להדפיס מקור — ממתין למספר הקצאה מרשות המסים"
- הדפסת עותקים — מותרת תמיד

## רישום בקשות

אוסף: `companies/{companyId}/assignment_requests/{requestId}`
```json
{
  "invoiceId": "מזהה החשבונית",
  "sequentialNumber": 42,
  "clientNumber": "מספר עוסק",
  "amountBeforeVAT": 25000.00,
  "vatAmount": 4500.00,
  "totalAmount": 29500.00,
  "requestedAt": "חותמת זמן שרת",
  "status": "approved",
  "assignmentNumber": "1234567890",
  "respondedAt": "חותמת זמן תשובה"
}
```

## Firestore Security Rules

```javascript
match /assignment_requests/{requestId} {
  allow read: if userCompanyId == companyId || userRole == 'super_admin';
  allow create: if userRole in ['admin', 'dispatcher'] || userRole == 'super_admin';
  allow update: if (userRole in ['admin', 'dispatcher'] || userRole == 'super_admin')
    && request.resource.data.invoiceId == resource.data.invoiceId;
  allow delete: if false;
}
```

## ממשק משתמש

- בדף ניהול חשבוניות — בייג' צבעוני לפי סטטוס:
  - ירוק: "הקצאה: {מספר}" (אושר)
  - כתום: "ממתין להקצאה" (pending)
  - אדום: "הקצאה נדחתה" (rejected)
  - אפור: "שגיאת הקצאה" (error)
