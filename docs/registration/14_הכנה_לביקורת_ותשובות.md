# הכנה לביקורת — שאלות ותשובות

## א. ארכיטקטורה

### ❓ היכן מאוחסנים הנתונים פיזית?
Google Cloud Firestore, אזור `me-west1` (תל אביב, ישראל).
כל הנתונים מאוחסנים בישראל. שכפול אוטומטי ב-3 אזורי זמינות.

### ❓ למי יש גישה לבסיס הנתונים?
- גישה ישירה ל-Firestore Console: רק מנהלי הפרויקט ב-Google Cloud (IAM)
- גישה מהאפליקציה: רק משתמשים מאומתים (Firebase Auth) — בהתאם לתפקיד ולחברה
- אין גישה אנונימית — כל בקשה דורשת `request.auth != null`

### ❓ האם יש הפרדה בין דיירים (Tenant Isolation)?
כן. כל הנתונים מאוחסנים בתת-אוספים: `companies/{companyId}/...`
Firestore Security Rules מוודאים שמשתמש יכול לגשת רק לנתוני החברה שלו:
```
userCompanyId == companyId
```
אין שאילתות חוצות-חברות. `companyId` נלקח מפרופיל המשתמש — לא מהלקוח.

### ❓ האם יש לוגיקה בצד השרת או הכל בצד הלקוח?
- **Firestore Security Rules** — לוגיקת אבטחה בצד השרת: אי-שינוי, אי-מחיקה, אטומיות מספור, append-only
- **Transactions** — מופעלים מצד הלקוח אך נאכפים בצד השרת (Rules מוודאים increment == 1)
- **serverTimestamp** — חותמות זמן נקבעות בשרת, לא בלקוח
- **מתוכנן**: העברת לוגיקת מספור ו-assignment ל-Cloud Functions (trusted backend)

### ❓ כיצד מובטחת שלמות הנתונים?
1. SHA-256 hash על שדות מוגנים + סכומים כספיים (`immutableSnapshotHash`)
2. שרשרת שלמות (Integrity Chain) — hash-chain על כל המסמכים
3. עוגנים חיצוניים (External Anchors) — snapshot רבעוני של hash אחרון בשרשרת
4. Firestore Security Rules — אכיפת whitelist לאחר סיום
5. Transactions אטומיות — כתיבה מלאה או לא כלום
5. serverTimestamp — שעון לקוח לא משפיע

---

## ב. מספור

### ❓ כיצד נמנעים כפילויות במספור?
Firestore Transaction אטומי: קריאה + הגדלה + כתיבה בפעולה אחת.
Security Rules מוודאים: `lastNumber == resource.data.lastNumber + 1`.
אם שני משתמשים מנסים בו-זמנית — Transaction מזהה conflict ומריץ retry אוטומטי.

### ❓ מה קורה ב-concurrent finalize?
Firestore Transaction מבטיח serialization — רק אחד מצליח, השני מקבל retry אוטומטי עם המספר הבא.

### ❓ האם ניתן לשנות מספר מסמך?
לא. `sequentialNumber` הוא שדה מוגן — לאחר סיום, Firestore Rules חוסמים שינוי.

### ❓ האם יש בדיקת פערים?
כן. `verifySequentialIntegrity()` בודקת לכל סוג מסמך: רציפות, היעדר כפילויות, היעדר פערים.
בעת גילוי פער:
1. רישום ביומן ביקורת (`sequential_integrity_gap_detected`)
2. החזרת `SequentialIntegrityResult` עם פרטי הפער
3. ניתן לחסום הדפסה עד לבירור

### ❓ האם ניתן להזין מספר ידנית?
לא. המספר מוקצה אוטומטית על ידי המערכת בלבד. אין ממשק להזנה ידנית.

---

## ג. אי-שינוי (Immutability)

### ❓ מה קורה בניסיון לשנות מסמך שעבר סיום?
1. **צד לקוח**: `ImmutabilityGuard` חוסם את הבקשה ומציג הודעה בעברית
2. **צד שרת**: Firestore Security Rules דוחים את הבקשה — גם אם הלקוח נפרץ
3. **הערבות המשפטית**: Firestore Rules — לא הלקוח

### ❓ כיצד מובטח enforcement — לקוח או שרת?
**שרת**. Firestore Security Rules הם ההגנה המשפטית.
הלקוח (ImmutabilityGuard) הוא רק UX — מונע שליחת בקשות שיידחו.

### ❓ האם יש hash snapshot?
כן. SHA-256 של כל השדות המוגנים + סכומים כספיים (subtotalBeforeVAT, vatAmount, totalWithVAT) — נשמר ב-`immutableSnapshotHash` בזמן הסיום.
כולל גם: companyId, createdBy, linkedInvoiceId, item.type, item.number.

### ❓ האם ניתן למחוק מסמך?
לא. `allow delete: if false` — בכל אוספי המסמכים החשבונאיים.

### ❓ כיצד מתקנים שגיאה?
הפקת מסמך זיכוי חדש. המסמך המקורי לא משתנה — רק נוצר קישור רשמי.

---

## ד. מסמכים

### ❓ אילו סוגי מסמכים נתמכים?
חשבונית מס, קבלה, תעודת משלוח, זיכוי — כל אחד עם סדרת מספור נפרדת.

### ❓ כיצד מקושר זיכוי למקור?
1. שדה `linkedInvoiceId` בזיכוי מצביע על המסמך המקורי
2. רשומת `document_links` (append-only) מתעדת את הקשר
3. שני אירועי ביקורת: על המקור (`creditNoteCreated`) ועל הזיכוי (`created`)

### ❓ כיצד מתבצע ביטול?
שינוי סטטוס ל-`cancelled` עם: סיבה (חובה), מבצע (UID), תאריך (serverTimestamp), רישום ביומן ביקורת.
המסמך לא נמחק — רק הסטטוס משתנה.
**log-before-action**: יומן הביקורת נרשם לפני ביצוע הביטול בפועל.

### ❓ האם ניתן לבטל ביטול?
לא. ביטול הוא פעולה חד-כיוונית. אם נדרש — יש להפיק מסמך חדש.

### ❓ האם יש lifecycle diagram?
```
טיוטה (draft) → סופי (active/finalized) → מבוטל (cancelled)
                                          → זיכוי (credit note — מסמך חדש)
```

---

## ה. הדפסה

### ❓ האם ניתן להדפיס מקור שוב?
לא. לאחר הדפסת מקור, השדה `originalPrinted` מסומן כ-`true`.
ניסיון נוסף — המערכת מפנה אוטומטית ל"עותק".

### ❓ כיצד המערכת מסמנת הדפסה חוזרת?
על גבי המסמך המודפס: "הדפסה חוזרת DD/MM/YYYY HH:MM" + סוג העותק (עותק / נאמן למקור).

### ❓ האם הדפסה מתועדת?
כן, בשני מקומות:
1. **יומן ביקורת** (`auditLog`) — אירוע `printed` עם מטא-נתונים
2. **אירועי הדפסה** (`printEvents`) — רשומה מפורטת: סוג, כמות, מדפיס, גרסת תבנית

### ❓ היכן נשמרת גרסת התבנית?
`companies/{companyId}/print_templates/{templateId}` — גרסה, תיאור, תאריך רישום.
כל אירוע הדפסה כולל `templateVersion` — מאפשר שחזור מדויק.

### ❓ האם ניתן להדפיס ללא מספר הקצאה?
- **מתחת לסף**: כן — לא נדרש מספר הקצאה
- **מעל הסף**: הדפסת מקור **חסומה** עד קבלת מספר הקצאה
- הדפסת עותקים — מותרת תמיד

---

## ו. חשבוניות ישראל (מספר הקצאה)

### ❓ מתי מבוקש מספר הקצאה?
אוטומטית לאחר סיום (finalization) — אם סכום לפני מע"מ מעל הסף.

### ❓ מה אם ה-API לא מגיב?
Exponential backoff: 3 ניסיונות (2s, 4s, 8s). Timeout: 30 שניות לכל ניסיון.
אם כל הניסיונות נכשלו — סטטוס `error`, רישום ביומן ביקורת.

### ❓ האם יש retry?
כן. אוטומטי (3 ניסיונות) + ידני (המשתמש יכול לבקש שוב).

### ❓ האם יש manual retry?
כן. אם הבקשה נכשלה — כפתור "ניסיון חוזר להקצאה" מופיע בממשק ניהול החשבוניות.
כל ניסיון נרשם ב-`assignment_requests` — היסטוריה מלאה.

### ❓ האם ניתן לסיים מסמך ללא מספר הקצאה?
כן — הסיום עצמו מתבצע. אבל הדפסת מקור חסומה עד קבלת המספר.

---

## ז. יומן ביקורת (Audit)

### ❓ אילו אירועים מתועדים?
יצירה, סיום, הדפסה, ייצוא, ביטול, זיכוי, שינוי סטטוס, עדכון טכני.
כל האירועים נרשמים **לפני** ביצוע הפעולה (log-before-action).
`actorUid` — תמיד Firebase Auth UID, לא שם משתמש. נאכף ב-Rules: `actorUid == request.auth.uid`.

### ❓ האם ניתן למחוק רשומת ביקורת?
לא. `allow delete: if false`.

### ❓ האם ניתן לשנות רשומת ביקורת?
לא. `allow update: if false`.

### ❓ היכן נשמרת חותמת הזמן?
`FieldValue.serverTimestamp()` — נקבעת בשרת. שעון הלקוח לא משפיע.

### ❓ האם יש יומן גישה?
כן. `companies/{companyId}/access_log/{logId}` — כניסה, יציאה, צפייה, הדפסה, ייצוא.
append-only, `actorUid == auth.uid`.

---

## ח. גיבוי

### ❓ היכן מאוחסן הגיבוי?
Google Cloud Storage, אזור `me-west1` (תל אביב). bucket נפרד מהייצור.
הצפנה: AES-256 (at-rest + in-transit).

### ❓ באיזו תדירות?
- **יומי**: Firestore automatic backups
- **רבעוני**: compliance backup בשבוע הראשון של כל רבעון
- **PITR**: Point-in-Time Recovery זמין

### ❓ האם יש בדיקת שחזור?
כן. `restore_tests` — רישום כל בדיקה: הצלחה/כישלון, מספר מסמכים, משך שחזור.

### ❓ האם יש תוכנית DR?
כן. Firestore Multi-Region replication + quarterly restore tests + documented procedures.
RTO: < 4 שעות, RPO: < 1 שעה.

### ❓ מי אחראי על הגיבוי?
מנהל המערכת (admin). המערכת מתריעה כשנדרש גיבוי רבעוני.

### ❓ מהי מדיניות שמירת הנתונים?
ראה מסמך מפורט: `15_מדיניות_שמירת_נתונים.md`
- שמירה: 7 שנים מתום שנת המס (חוק ניהול ספרים)
- מיקום: Google Cloud, אזור me-west1 (תל אביב)
- הצפנה: AES-256 at-rest, TLS 1.2+ in-transit
- מחיקה: אסורה למסמכים חשבונאיים
- ארכוב: רק לאחר 7 שנים, רק על ידי admin

---

## ט. אבטחה

### ❓ כיצד עובד RBAC?
5 תפקידים: super_admin, admin, dispatcher, driver, warehouse_keeper.
כל תפקיד עם הרשאות מוגדרות ב-Firestore Security Rules.

### ❓ האם יש least privilege?
כן. נהג רואה רק את המסלול שלו. מחסנאי רואה רק מלאי. מוקדן לא יכול למחוק.

### ❓ האם התקשורת מוצפנת?
כן. HTTPS בלבד (Firebase default). TLS 1.2+.

### ❓ האם יש הפרדת נתונים?
כן. Tenant Isolation — כל חברה בתת-אוספים נפרדים. Rules אוכפים.

### ❓ האם יש זיהוי פריצה?
- Firebase App Check — הגנה מפני בקשות לא מורשות
- Firestore Rules — חסימת כל פעולה לא מורשית
- Audit log — כל פעולה נרשמת לזיהוי חריגות

---

## י. קובץ במבנה אחיד

### ❓ כיצד נוצר הקובץ?
`UniformExportService.exportPeriod()` — CSV עם כל המסמכים לתקופה נתונה.

### ❓ האם יש מטא-נתונים?
כן. כותרת: חברה, תקופה, תאריך הפקה, מפיק, מספר רשומות. סיום: "סוף קובץ".

### ❓ האם הקובץ נבדק בסימולטור?
⬜ **נדרש**: להריץ את הקובץ דרך סימולטור רשות המסים ולצרף את הדוח.

### ❓ האם יש רישום ייצוא?
כן. `uniform_export_runs` — append-only. כל ריצה נרשמת עם: תקופה, מפיק, מספר רשומות.

### ❓ האם ניתן לייצא כל תקופה?
כן. ניתן לבחור תאריך התחלה וסיום, וסינון לפי סוג מסמך.
