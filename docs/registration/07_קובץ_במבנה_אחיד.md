# קובץ במבנה אחיד (Uniform Format Export)

## תיאור

המערכת מייצרת קובץ במבנה אחיד בהתאם לדרישות רשות המסים.
הקובץ מכיל את כל הרשומות החשבונאיות לתקופה נתונה בפורמט CSV.

## פורמט הקובץ

### קידוד
- UTF-8 עם BOM (תאימות Excel)
- מפריד: פסיק (,)
- שדות עם פסיקים/מרכאות: עטופים במרכאות כפולות

### כותרת מטא-נתונים
```
# קובץ במבנה אחיד — ייצוא רשומות
# חברה: {companyId}
# תקופה: 01/01/2026 - 31/03/2026
# תאריך הפקה: 15/04/2026 10:30
# מפיק: admin_user
# סה"כ רשומות: 1500
```

### עמודות

| # | שם עמודה | תיאור |
|---|----------|--------|
| 1 | מס_שורה | מספר שורה רץ |
| 2 | סוג_מסמך | חשבונית_מס / קבלה / תעודת_משלוח / זיכוי |
| 3 | מספר_רץ | מספר סידורי |
| 4 | תאריך_יצירה | DD/MM/YYYY |
| 5 | שם_לקוח | שם הלקוח |
| 6 | מספר_לקוח | מספר/קוד לקוח |
| 7 | כתובת | כתובת הלקוח |
| 8 | נהג | שם הנהג |
| 9 | מספר_רכב | מספר רכב |
| 10 | תאריך_אספקה | DD/MM/YYYY |
| 11 | תשלום_עד | DD/MM/YYYY |
| 12 | סכום_לפני_מעמ | סכום לפני מע"מ |
| 13 | מעמ | סכום מע"מ |
| 14 | סכום_כולל | סכום כולל מע"מ |
| 15 | הנחה_אחוז | אחוז הנחה |
| 16 | סטטוס | active / cancelled / draft |
| 17 | מקור_הודפס | כן / לא |
| 18 | עותקים | מספר עותקים שהודפסו |
| 19 | מזהה_מסמך | מזהה ייחודי במערכת |
| 20 | מסמך_מקושר | מזהה מסמך מקושר (לזיכויים) |

### סיום קובץ
```
# --- סוף קובץ ---
```

## רישום ריצות ייצוא

כל ייצוא נרשם ב-`companies/{companyId}/uniform_export_runs/{runId}`:
```json
{
  "fromDate": "תחילת תקופה",
  "toDate": "סוף תקופה",
  "exportedBy": "מבצע הייצוא",
  "exportedAt": "חותמת זמן שרת",
  "recordCount": 1500,
  "format": "csv_uniform",
  "docTypeFilter": null
}
```

## סינון

- ניתן לסנן לפי סוג מסמך (חשבונית מס בלבד, קבלות בלבד, וכו')
- ניתן לסנן לפי תקופה (מתאריך — עד תאריך)

## Firestore Security Rules

```javascript
match /uniform_export_runs/{runId} {
  allow read: if userRole in ['super_admin', 'admin'];
  allow create: if userRole in ['super_admin', 'admin', 'dispatcher'];
  allow update: if false;
  allow delete: if false;
}
```

## שימוש בסימולטור

הקובץ שנוצר מיועד להיבדק על ידי סימולטור רשות המסים.
דוח הסימולטור מצורף לבקשת הרישום.
