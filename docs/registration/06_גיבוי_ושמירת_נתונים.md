# גיבוי ושמירת נתונים

## מדיניות שמירה

- **תקופת שמירה מינימלית**: 7 שנים (לפי חוק ניהול ספרים)
- **מחיקת מסמכים**: אסורה — `allow delete: if false` בכל אוספי המסמכים
- **בדיקת עמידה**: פונקציה `runRetentionCheck()` בודקת:
  - מספר מסמכים כולל
  - תאריך המסמך הישן ביותר
  - פערים במספור (אינדיקציה למחיקה)
  - תוצאה: תקין / בעיות

## גיבוי רבעוני

### לוח זמנים
- גיבוי נדרש **בשבוע הראשון של כל רבעון**:
  - ינואר (Q1)
  - אפריל (Q2)
  - יולי (Q3)
  - אוקטובר (Q4)

### תהליך
1. המערכת מזהה שנדרש גיבוי (`isQuarterlyBackupDue()`)
2. מנהל מבצע גיבוי ומתעד:
   - מיקום הגיבוי (מקום נפרד)
   - מבצע הגיבוי
   - הערות
3. רישום ב-`companies/{companyId}/backups/{backupId}`

### אחסון גיבויים
- **מקום נפרד**: הגיבוי חייב להיות במיקום שונה מהמערכת הראשית
- **אם ההכנסה בישראל**: אחסון בישראל או באזור מורשה
- **מיקום פיזי**: Google Cloud Storage bucket באזור `me-west1` (תל אביב, ישראל)
- **הצפנה**: הגיבויים מוצפנים ב-AES-256 (Google-managed encryption keys) — הצפנה בזמן אחסון (at-rest) ובזמן העברה (in-transit)
- **הפרדה**: bucket הגיבוי נפרד מ-bucket הייצור — אין גישה ישירה מהאפליקציה
- Firebase: Firestore automatic daily backups + manual PITR (Point-in-Time Recovery) + quarterly compliance exports

## בדיקת שחזור (Restore Test)

### מטרה
הוכחת יכולת שחזור — אודיטור דורש לראות שהגיבוי עובד בפועל.

### תהליך
1. שחזור מגיבוי לסביבת בדיקה
2. אימות מספר מסמכים
3. אימות שלמות נתונים
4. רישום תוצאה ב-`companies/{companyId}/restore_tests/{testId}`

### שדות רשומת בדיקת שחזור
```json
{
  "performedBy": "מבצע הבדיקה",
  "success": true,
  "backupId": "מזהה הגיבוי שנבדק",
  "timestamp": "חותמת זמן שרת",
  "quarter": "Q1",
  "year": 2026,
  "documentsVerified": 1500,
  "restoreDurationMs": 45000,
  "notes": "שחזור מלא — כל המסמכים תקינים"
}
```

## דוח מצב גיבויים

פונקציה `getBackupComplianceReport()` מחזירה:
```json
{
  "currentQuarter": "Q1",
  "year": 2026,
  "isCurrentQuarterBackedUp": true,
  "backupsDue": false,
  "totalBackupsRecorded": 4,
  "lastRestoreTestSuccess": true,
  "totalRestoreTests": 4,
  "compliant": true
}
```

## הגנה מפני כשל חשמל

- Firebase Firestore: כל כתיבה היא אטומית (Transaction)
- אם הכתיבה לא הושלמה — היא לא נשמרת (ACID)
- log-before-action: יומן ביקורת נכתב לפני הפעולה
- אם הפעולה נכשלה — היומן מתעד את הניסיון
- Firestore: שכפול אוטומטי ב-3 אזורי זמינות (Multi-Region)

## Firestore Security Rules — גיבויים

```javascript
// גיבויים — append-only
match /backups/{backupId} {
  allow read: if userRole in ['super_admin', 'admin'];
  allow create: if userRole in ['super_admin', 'admin'];
  allow update: if false;
  allow delete: if false;
}

// בדיקות שחזור — append-only
match /restore_tests/{testId} {
  allow read: if userRole in ['super_admin', 'admin'];
  allow create: if userRole in ['super_admin', 'admin'];
  allow update: if false;
  allow delete: if false;
}

// בדיקות מדיניות שמירה — append-only
match /retention_checks/{checkId} {
  allow read: if userRole in ['super_admin', 'admin'];
  allow create: if userRole in ['super_admin', 'admin'];
  allow update: if false;
  allow delete: if false;
}
```
