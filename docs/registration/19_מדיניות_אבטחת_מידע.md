# מדיניות אבטחת מידע — Security Policy

## 1. עקרונות

- **Least Privilege**: כל תפקיד מקבל רק את ההרשאות הנדרשות
- **Defense in Depth**: הגנה בשכבות (Auth → Rules → Application)
- **Zero Trust**: כל בקשה נבדקת — אין הנחות על אמינות הלקוח
- **Immutability by Default**: מסמכים חשבונאיים לא ניתנים לשינוי/מחיקה

## 2. אימות (Authentication)

| רכיב | מימוש |
|-------|--------|
| ספק | Firebase Authentication |
| שיטות | Email/Password |
| Session | Firebase Auth tokens (JWT) |
| Token expiry | 1 שעה (auto-refresh) |
| אין גישה אנונימית | `request.auth != null` בכל Rule |

## 3. הרשאות (Authorization — RBAC)

| תפקיד | הרשאות |
|--------|---------|
| super_admin | גישה מלאה לכל החברות |
| admin | ניהול מלא של החברה שלו |
| dispatcher | יצירה/עדכון מסמכים, הדפסה |
| driver | צפייה במסלולים, עדכון מיקום |
| warehouse_keeper | ניהול מלאי |

### 3.1 אכיפה
- Firestore Security Rules — צד שרת
- Application-level checks — צד לקוח (UX בלבד)
- הערבות המשפטית: Rules בלבד

## 4. הצפנה

| שכבה | סוג | ספק |
|------|------|------|
| At-rest | AES-256 | Google (managed keys) |
| In-transit | TLS 1.2+ | Firebase (HTTPS default) |
| Backups | AES-256 | Google Cloud Storage |

## 5. הפרדת דיירים (Tenant Isolation)

- כל הנתונים בתת-אוספים: `companies/{companyId}/...`
- Rules אוכפים: `userCompanyId == companyId`
- אין שאילתות חוצות-חברות
- `companyId` נלקח מפרופיל המשתמש — לא מהלקוח

## 6. יומני אבטחה

| יומן | מיקום | סוג |
|------|-------|------|
| Audit Log | `invoices/{id}/auditLog/` | append-only |
| Access Log | `access_log/` | append-only |
| Print Events | `invoices/{id}/printEvents/` | append-only |
| Cloud Audit Logs | Google Cloud Console | managed |

### 6.1 אירועים מתועדים
- כניסה/יציאה
- צפייה במסמך
- יצירה/סיום/ביטול
- הדפסה (סוג, כמות, מדפיס)
- ייצוא נתונים
- פעולות מנהל

## 7. הגנה על נתונים

### 7.1 נתונים חשבונאיים
- לא ניתנים למחיקה (7 שנים)
- לא ניתנים לשינוי לאחר סיום
- hash snapshot + integrity chain

### 7.2 נתונים אישיים
- מאוחסנים בישראל (me-west1)
- גישה רק למורשים
- תואם לחוק הגנת הפרטיות

## 8. Firebase App Check

- הגנה מפני בקשות לא מורשות
- אימות שהבקשה מגיעה מאפליקציה לגיטימית
- חסימת גישה ישירה ל-API

## 9. Firestore Security Rules — עקרונות

1. **אין גישה ללא אימות**: `request.auth != null`
2. **Tenant isolation**: `userCompanyId == companyId`
3. **Immutability**: field-level protection לאחר סיום
4. **No delete**: `allow delete: if false` על אוספים חשבונאיים
5. **Append-only**: audit, print events, access log
6. **Atomic numbering**: `lastNumber == resource.data.lastNumber + 1`
7. **Actor verification**: `actorUid == request.auth.uid`

> Rules אוכפים ברמת שדה בודד, ללא תלות בשיטת כתיבה (single/batch/transaction).

## 10. סקירה ועדכון

- סקירת מדיניות: פעם בשנה
- עדכון Rules: לאחר כל שינוי בדרישות
- בדיקת חדירה: מתוכננת לפני השקה

---

**תאריך**: פברואר 2026
**גרסה**: 1.0
