# אבטחה והרשאות

## אימות (Authentication)

- **ספק**: Firebase Authentication
- **שיטות**: אימייל + סיסמה
- **טוקן**: JWT — מאומת בכל בקשה ל-Firestore
- **session**: מנוהל אוטומטית על ידי Firebase SDK

## הרשאות (Authorization)

### תפקידים

| תפקיד | קוד | הרשאות |
|--------|------|---------|
| סופר-אדמין | `super_admin` | גישה מלאה לכל החברות |
| מנהל | `admin` | ניהול חברה ספציפית |
| מוקדן | `dispatcher` | הפקת מסמכים, ניהול מסלולים |
| נהג | `driver` | צפייה במסלול, עדכון סטטוס |
| מחסנאי | `warehouse_keeper` | ניהול מלאי |

### מטריצת הרשאות — מסמכים חשבונאיים

| פעולה | super_admin | admin | dispatcher | driver | warehouse |
|--------|:-----------:|:-----:|:----------:|:------:|:---------:|
| קריאה | ✅ | ✅ | ✅ | ❌ | ❌ |
| יצירה | ✅ | ✅ | ✅ | ❌ | ❌ |
| עדכון (לפני סיום) | ✅ | ✅ | ✅ | ❌ | ❌ |
| עדכון (אחרי סיום) | whitelist | whitelist | whitelist | ❌ | ❌ |
| מחיקה | ❌ | ❌ | ❌ | ❌ | ❌ |
| הדפסה | ✅ | ✅ | ✅ | ❌ | ❌ |
| ביטול | ✅ | ✅ | ✅ | ❌ | ❌ |

### מטריצת הרשאות — יומן ביקורת

| פעולה | super_admin | admin | dispatcher | driver | warehouse |
|--------|:-----------:|:-----:|:----------:|:------:|:---------:|
| קריאה | ✅ | ✅ | ✅ | ❌ | ❌ |
| יצירה | ✅ | ✅ | ✅ | ❌ | ❌ |
| עדכון | ❌ | ❌ | ❌ | ❌ | ❌ |
| מחיקה | ❌ | ❌ | ❌ | ❌ | ❌ |

## Firestore Security Rules — עקרונות

1. **כל בקשה דורשת אימות**: `request.auth != null`
2. **הפרדת דיירים**: `userCompanyId == companyId`
3. **append-only**: יומני ביקורת, אירועי הדפסה, שרשרת שלמות
4. **אי-מחיקה**: מסמכים חשבונאיים, מוני מספור
5. **אי-שינוי**: שדות מוגנים לאחר סיום
6. **אטומיות מספור**: `lastNumber == resource.data.lastNumber + 1`
7. **זיהוי שחקן**: `actorUid == request.auth.uid`

## הגנות נוספות

### הגנה בצד לקוח (UX)
- `ImmutabilityGuard` — מונע שליחת בקשות שיידחו
- הודעות שגיאה בעברית
- חסימת כפתורים לפי סטטוס

### הגנה בצד שרת (Firestore Rules)
- **הערבות המשפטית** — Firestore Security Rules
- הלקוח (ImmutabilityGuard) הוא רק UX
- גם אם הלקוח נפרץ — השרת חוסם שינויים אסורים

### HTTPS
- כל התקשורת מוצפנת (Firebase default)
- אין תקשורת לא מוצפנת

### יומן גישה
- כל כניסה/יציאה נרשמת
- כל צפייה/הדפסה/ייצוא נרשמת
- append-only — לא ניתן למחוק
