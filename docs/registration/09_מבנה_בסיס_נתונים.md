# מבנה בסיס נתונים

## טכנולוגיה

- **מסד נתונים**: Google Cloud Firestore (NoSQL)
- **אימות**: Firebase Authentication
- **אחסון**: Firebase Storage (לוגואים, קבצים)
- **אירוח**: Firebase Hosting (Web), APK (Android)

## מבנה אוספים

### אוספים ראשיים
```
users/{userId}                          — משתמשים
companies/{companyId}                   — חברות
driver_locations/{driverId}             — מיקומי נהגים (GPS)
```

### תת-אוספים של חברה
```
companies/{companyId}/
  ├── settings/{settingId}              — הגדרות חברה
  ├── clients/{clientId}                — לקוחות
  ├── product_types/{productTypeId}     — סוגי מוצרים
  ├── box_types/{boxTypeId}             — סוגי אריזות
  ├── inventory/{inventoryId}           — מלאי
  ├── prices/{priceId}                  — מחירון
  ├── delivery_points/{pointId}         — נקודות מסירה
  ├── inventory_history/{historyId}     — היסטוריית מלאי
  │
  ├── invoices/{invoiceId}              — מסמכים חשבונאיים
  │   ├── auditLog/{eventId}            — יומן ביקורת (append-only)
  │   └── printEvents/{eventId}         — אירועי הדפסה (append-only)
  │
  ├── counters/{docType}                — מוני מספור (אטומי)
  ├── document_links/{linkId}           — קישורים בין מסמכים
  ├── integrity_chain/{chainId}         — שרשרת שלמות
  │
  ├── assignment_requests/{requestId}   — בקשות מספר הקצאה
  │
  ├── uniform_export_runs/{runId}       — ריצות ייצוא
  ├── backups/{backupId}                — רישומי גיבוי
  ├── restore_tests/{testId}            — בדיקות שחזור
  ├── retention_checks/{checkId}        — בדיקות מדיניות שמירה
  │
  ├── access_log/{logId}                — יומן גישה
  └── print_templates/{templateId}      — גרסאות תבניות הדפסה
```

## מסמך חשבונאי (Invoice)

### שדות ליבה
| שדה | סוג | תיאור |
|------|------|--------|
| companyId | String | מזהה חברה |
| sequentialNumber | int | מספר רץ |
| documentType | Enum | סוג מסמך |
| status | Enum | סטטוס (active/cancelled/draft) |
| clientName | String | שם לקוח |
| clientNumber | String | מספר לקוח |
| address | String | כתובת |
| items | Array | פריטים |
| discount | double | הנחה (%) |
| deliveryDate | Timestamp | תאריך אספקה |
| paymentDueDate | Timestamp? | תשלום עד |
| createdAt | Timestamp | תאריך יצירה |
| createdBy | String | יוצר |

### שדות הדפסה
| שדה | סוג | תיאור |
|------|------|--------|
| originalPrinted | bool | האם מקור הודפס |
| copiesPrinted | int | מספר עותקים |
| printedCount | int | מונה הדפסות כולל |

### שדות סיום ושלמות
| שדה | סוג | תיאור |
|------|------|--------|
| finalizedAt | Timestamp? | תאריך סיום |
| finalizedBy | String? | מסיים |
| immutableSnapshotHash | String? | SHA-256 |
| linkedInvoiceId | String? | מסמך מקושר |

### שדות ביטול
| שדה | סוג | תיאור |
|------|------|--------|
| cancelledAt | Timestamp? | תאריך ביטול |
| cancelledBy | String? | מבטל |
| cancellationReason | String? | סיבת ביטול |

### שדות מספר הקצאה
| שדה | סוג | תיאור |
|------|------|--------|
| assignmentNumber | String? | מספר הקצאה |
| assignmentStatus | Enum | סטטוס הקצאה |
| assignmentRequestedAt | Timestamp? | תאריך בקשה |
| assignmentResponseRaw | String? | תשובה גולמית |

## פריט (InvoiceItem)

| שדה | סוג | תיאור |
|------|------|--------|
| productCode | String | מק"ט |
| type | String | סוג פריט |
| number | String | מספר |
| quantity | int | כמות |
| pricePerUnit | double | מחיר ליחידה |

## הפרדת דיירים (Tenant Isolation)

- כל הנתונים מאוחסנים תחת `companies/{companyId}/`
- Firestore Security Rules מוודאים:
  - `userCompanyId == companyId` — גישה רק לנתוני החברה שלך
  - `super_admin` — גישה לכל החברות
- אין שאילתות חוצות-חברות
- `companyId` נלקח מ-`CompanyContext.effectiveCompanyId` (לא hardcoded)
