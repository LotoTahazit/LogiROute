# אי-שינוי ושלמות מסמכים (Immutability & Integrity)

## עקרון מנחה

מסמך חשבונאי שעבר סיום (finalization) **לא ניתן לשינוי**.
התיקון היחיד האפשרי הוא הפקת מסמך זיכוי חדש.

## מחזור חיי מסמך

```
טיוטה (draft) → סופי (active/finalized) → מבוטל (cancelled)
                                          → זיכוי (credit note — מסמך חדש)
```

### שלב 1: טיוטה
- ניתן לעריכה חופשית
- מסומן בבירור: "טיוטה — לא לשימוש רשמי" (בדפוס ובמסך)
- לא מקבל מספר הקצאה

### שלב 2: סיום (Finalization)
- מתבצע על ידי `finalizeInvoice()`
- נרשמים:
  - `finalizedAt` — חותמת זמן שרת
  - `finalizedBy` — UID המשתמש
  - `immutableSnapshotHash` — SHA-256 של כל השדות המוגנים
- המסמך מתווסף לשרשרת שלמות (Integrity Chain)
- אם נדרש — נשלחת בקשת מספר הקצאה אוטומטית

### שלב 3: לאחר סיום
- שדות מוגנים **לא ניתנים לשינוי** (Firestore Security Rules)
- רק שדות whitelist מותרים לעדכון

## שדות מוגנים (Protected Fields)

| שדה | תיאור |
|------|--------|
| companyId | מזהה חברה |
| sequentialNumber | מספר רץ |
| clientName | שם לקוח |
| clientNumber | מספר לקוח |
| address | כתובת |
| driverName | שם נהג |
| truckNumber | מספר רכב |
| departureTime | שעת יציאה |
| items | פריטים |
| discount | הנחה |
| deliveryDate | תאריך אספקה |
| paymentDueDate | תשלום עד |
| createdAt | תאריך יצירה |
| createdBy | יוצר |
| documentType | סוג מסמך |
| finalizedAt | תאריך סיום |
| finalizedBy | מסיים |
| immutableSnapshotHash | חתימת שלמות |
| linkedInvoiceId | מסמך מקושר |

## שדות מותרים לעדכון (Whitelist)

| שדה | תיאור |
|------|--------|
| lastViewedAt | צפייה אחרונה |
| printedCount | מונה הדפסות |
| exportedAt | תאריך ייצוא |
| originalPrinted | האם מקור הודפס |
| copiesPrinted | מספר עותקים |
| status | סטטוס (רק active→cancelled) |
| assignmentNumber | מספר הקצאה |
| assignmentStatus | סטטוס הקצאה |
| assignmentRequestedAt | תאריך בקשת הקצאה |
| assignmentResponseRaw | תשובת API |

## אכיפה — Firestore Security Rules

```javascript
allow update: if (
  resource.data.finalizedAt == null ||  // מסמך לא עבר סיום — חופשי
  (
    // מסמך עבר סיום — רק whitelist
    request.resource.data.sequentialNumber == resource.data.sequentialNumber &&
    request.resource.data.clientName == resource.data.clientName &&
    // ... כל השדות המוגנים חייבים להישאר זהים
  )
);
```

> **הערה חשובה**: Firestore Security Rules אוכפים אי-שינוי ברמת שדה בודד, ללא תלות בשיטת הכתיבה (single write / batch write / transaction). כל מסמך בתוך batch נבדק בנפרד מול ה-Rules — אין אפשרות לעקוף.

## שרשרת שלמות (Integrity Chain)

- כל מסמך שעבר סיום מתווסף לשרשרת
- כל חוליה מכילה:
  - `documentId` — מזהה המסמך
  - `documentHash` — SHA-256 של המסמך
  - `prevHash` — hash של החוליה הקודמת
  - `chainHash` — SHA-256 של (prevHash + documentHash)
  - `sequenceNumber` — מספר סידורי בשרשרת
- פונקציה `verifyChain()` מאמתת את כל השרשרת
- אוסף: `companies/{companyId}/integrity_chain/{chainId}`
- append-only — עדכון ומחיקה אסורים

## חישוב Hash (SHA-256)

Hash כולל את כל השדות המוגנים + סכומים כספיים (קריטי למס):

```dart
String computeSnapshotHash() {
  final buffer = StringBuffer();
  buffer.write(companyId);
  buffer.write(sequentialNumber);
  buffer.write(clientName);
  buffer.write(clientNumber);
  buffer.write(address);
  buffer.write(driverName);
  buffer.write(truckNumber);
  buffer.write(departureTime.toIso8601String());
  for (final item in items) {
    buffer.write(item.productCode);
    buffer.write(item.type);
    buffer.write(item.number);
    buffer.write(item.quantity);
    buffer.write(item.pricePerUnit);
  }
  buffer.write(discount);
  buffer.write(deliveryDate.toIso8601String());
  if (paymentDueDate != null) {
    buffer.write(paymentDueDate!.toIso8601String());
  }
  buffer.write(createdAt.toIso8601String());
  buffer.write(createdBy);
  buffer.write(documentType.name);
  if (linkedInvoiceId != null) {
    buffer.write(linkedInvoiceId!);
  }
  // סכומים — קריטי למס
  buffer.write(subtotalBeforeVAT.toStringAsFixed(2));
  buffer.write(vatAmount.toStringAsFixed(2));
  buffer.write(totalWithVAT.toStringAsFixed(2));
  return sha256.convert(utf8.encode(buffer.toString())).toString();
}
```

## עוגנים חיצוניים (External Anchors)

- snapshot של ה-hash האחרון בשרשרת
- נשמר ב-`companies/{companyId}/integrity_anchors/{anchorId}`
- append-only — עדכון ומחיקה אסורים
- מומלץ: פעם ברבעון, לפני גיבוי
- ניתן לייצא ל-Cloud Storage / Git / external log
- פונקציה `verifyAnchor()` מאמתת שהעוגן תואם לשרשרת
