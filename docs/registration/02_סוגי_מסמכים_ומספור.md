# סוגי מסמכים ומספור רץ

## סוגי מסמכים נתמכים

המערכת תומכת בסוגי המסמכים הבאים:

| סוג מסמך | קוד פנימי | סדרת מספור |
|-----------|-----------|------------|
| חשבונית מס | `invoice` | סדרה נפרדת |
| קבלה | `receipt` | סדרה נפרדת |
| תעודת משלוח | `delivery` | סדרה נפרדת |
| זיכוי | `creditNote` | סדרה נפרדת |

## מספור רץ

### עקרונות
- לכל סוג מסמך סדרת מספור נפרדת ועצמאית
- המספור רציף, ללא דילוגים וללא כפילויות
- הקצאת מספר מתבצעת באופן אטומי (Firestore Transaction)

### מנגנון טכני
- מונה לכל סוג מסמך: `companies/{companyId}/counters/{docType}`
- כל הקצאה מתבצעת בתוך Firestore Transaction:
  1. קריאת המונה הנוכחי
  2. הגדלה ב-1
  3. כתיבה אטומית
- Firestore Security Rules מוודאים: `lastNumber == resource.data.lastNumber + 1`
- יצירת מונה חדש מותרת רק עם `lastNumber == 1`

### מי מבצע את ה-Transaction?
- כרגע: ה-Transaction מופעל מצד הלקוח (Flutter SDK) דרך `FirebaseFirestore.runTransaction()`
- **ההגנה המשפטית היא בצד השרת**: Firestore Security Rules אוכפים שה-increment הוא בדיוק +1, ללא קשר למי שמבצע את הקריאה
- גם אם לקוח זדוני ינסה לדלג על מספר או לכתוב מספר כפול — השרת ידחה את הבקשה
- **שלב הבא (מתוכנן)**: העברת לוגיקת המספור ל-Cloud Function (trusted backend) לשכבת הגנה נוספת

### בדיקת שלמות מספור
- פונקציה `verifySequentialIntegrity()` בודקת לכל סוג מסמך:
  - רציפות המספרים (1, 2, 3, ...)
  - היעדר כפילויות
  - היעדר פערים

### דוגמה
```
חשבונית מס: 1, 2, 3, 4, 5...
קבלה:       1, 2, 3...
תעודת משלוח: 1, 2, 3, 4...
זיכוי:      1, 2...
```

## מחיקה

**מחיקת מסמכים אסורה** — Firestore Security Rules:
```
allow delete: if false;
```

ביטול מסמך מתבצע על ידי שינוי סטטוס ל-`cancelled` עם תיעוד:
- סיבת ביטול (**חובה** — המערכת לא מאפשרת ביטול ללא סיבה)
- מבצע הביטול (UID + שם)
- תאריך ושעה (חותמת זמן שרת)
- רישום ביומן ביקורת (log-before-action)
- רק משתמשים בתפקיד admin, dispatcher או super_admin רשאים לבטל
