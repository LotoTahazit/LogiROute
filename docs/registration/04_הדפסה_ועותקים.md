# הדפסה ועותקים

## סוגי הדפסה

| סוג | קוד | תיאור |
|------|------|--------|
| מקור | `original` | עותק ראשון ויחיד — הדפסה אחת בלבד |
| עותק | `copy` | העתק נוסף — ללא הגבלה |
| נאמן למקור | `replacesOriginal` | מחליף את המקור — עם סימון מתאים |

## כללי הדפסה

### מקור (original)
- **הדפסה אחת בלבד** — לפי חוק ניהול ספרים
- לאחר הדפסת מקור, השדה `originalPrinted` מסומן כ-`true`
- ניסיון להדפיס מקור שוב — המערכת מפנה אוטומטית ל"עותק"
- **חסימה**: אם נדרש מספר הקצאה ולא התקבל — הדפסת מקור חסומה

### הדפסה ראשונה (First Print)
- מייצרת PDF אחד עם 3 עמודים:
  - 1 × מקור
  - 2 × עותק
- רישום ביומן ביקורת לפני יצירת ה-PDF (log-before-action)

### הדפסה חוזרת
- סימון "הדפסה חוזרת" עם תאריך ושעה על גבי המסמך
- בחירת סוג: עותק / נאמן למקור
- בחירת כמות (1-10)

### הדפסת מסלול
- הדפסת כל חשבוניות המסלול ב-PDF אחד
- לכל חשבונית: 1 מקור + 2 עותקים
- חשבוניות הממתינות למספר הקצאה — מדולגות עם התראה

## תוכן המסמך המודפס

### כותרת
- שם החברה (עברית + אנגלית)
- ח.פ.
- כתובת, טלפון, פקס, אתר

### גוף המסמך
- **סוג מסמך**: חשבונית מס / קבלה / תעודת משלוח / זיכוי
- **מספר רץ**: מספר סידורי ייחודי לסוג
- **סוג עותק**: מקור / עותק / נאמן למקור
- **תאריך ושעה**: תאריך הפקה
- **תשלום עד**: תאריך תשלום
- **פרטי לקוח**: שם, מספר, כתובת
- **טבלת פריטים**: מק"ט, תיאור, כמות, מחיר ליחידה, סה"כ
- **סיכום**: סה"כ לפני מע"מ, מע"מ 18%, סה"כ לתשלום
- **חתימה**: שדה חתימה
- **נהג ורכב**: שם נהג, מספר רכב, שעת יציאה

### סימונים מיוחדים
- **טיוטה**: מסגרת אדומה "טיוטה — לא לשימוש רשמי"
- **הדפסה חוזרת**: תאריך ושעת ההדפסה החוזרת
- **מטא-נתונים**: מזהה מסמך, תאריך הפקה (בתחתית)

## רישום אירועי הדפסה

כל הדפסה נרשמת בשני מקומות:

### 1. יומן ביקורת (Audit Log)
- אוסף: `companies/{cId}/invoices/{iId}/auditLog/{eId}`
- סוג אירוע: `printed`
- מטא-נתונים: סוג עותק, כמות, האם הדפסה ראשונה

### 2. אירועי הדפסה (Print Events)
- אוסף: `companies/{cId}/invoices/{iId}/printEvents/{eId}`
- שדות: `documentId`, `printedBy`, `printedByName`, `mode`, `copiesCount`, `templateVersion`
- append-only — עדכון ומחיקה אסורים
- `printedBy` חייב להתאים ל-`auth.uid` (Firestore Rules)

## גרסאות תבנית הדפסה

- כל גרסת תבנית נרשמת ב-`companies/{cId}/print_templates/{tId}`
- שדות: `version`, `description`, `registeredAt`, `registeredBy`
- מאפשר שחזור מדויק של מסמך כפי שהודפס
