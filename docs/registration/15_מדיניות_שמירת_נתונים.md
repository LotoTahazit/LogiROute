# מדיניות שמירת נתונים — Data Retention Policy

## 1. מסגרת חוקית

מדיניות זו נקבעה בהתאם לדרישות:
- **חוק ניהול ספרים** — תקנות ניהול פנקסי חשבונות, סעיף 25
- **פקודת מס הכנסה** — סעיף 25(ב)
- **חוק מע"מ** — סעיף 38
- **הנחיות רשות המסים** — ניהול ספרים ממוחשב

## 2. תקופת שמירה

| סוג מסמך | תקופת שמירה | בסיס חוקי |
|-----------|-------------|-----------|
| חשבוניות מס | 7 שנים מתום שנת המס | פקודת מס הכנסה |
| קבלות | 7 שנים מתום שנת המס | פקודת מס הכנסה |
| תעודות משלוח | 7 שנים מתום שנת המס | תקנות ניהול ספרים |
| זיכויים | 7 שנים מתום שנת המס | פקודת מס הכנסה |
| יומני ביקורת | 7 שנים מתום שנת המס | הנחיות רשות המסים |
| אירועי הדפסה | 7 שנים מתום שנת המס | הנחיות רשות המסים |
| שרשרת שלמות | 7 שנים מתום שנת המס | הנחיות רשות המסים |
| קישורי מסמכים | 7 שנים מתום שנת המס | הנחיות רשות המסים |
| יומני גישה | 7 שנים מתום שנת המס | SaaS compliance |
| גיבויים | 7 שנים מתום שנת המס | הנחיות רשות המסים |

**הערה**: תקופת השמירה מתחילה מתום שנת המס שבה נוצר המסמך.
לדוגמה: מסמך שנוצר ב-15/03/2026 — יישמר עד 31/12/2033 לפחות.

## 3. מיקום אחסון פיזי

| רכיב | מיקום | אזור |
|-------|-------|------|
| בסיס נתונים ראשי | Google Cloud Firestore | me-west1 (תל אביב, ישראל) |
| גיבויים רבעוניים | Google Cloud Storage | me-west1 (תל אביב, ישראל) |
| גיבויים יומיים | Firestore Automatic Backups | me-west1 |
| PITR | Firestore Point-in-Time Recovery | me-west1 |

**כל הנתונים מאוחסנים בישראל.**

## 4. הצפנה

| שכבה | סוג הצפנה |
|------|-----------|
| At-rest | AES-256 (Google managed) |
| In-transit | TLS 1.2+ (HTTPS) |
| Backups | AES-256 (Google managed) |

## 5. גישה לנתונים

### 5.1 גישה מהאפליקציה
- **super_admin**: גישה לכל הנתונים
- **admin**: גישה לנתוני החברה שלו בלבד
- **dispatcher**: קריאה/כתיבה למסמכים חשבונאיים
- **driver**: קריאה בלבד למסלולים
- **warehouse_keeper**: קריאה/כתיבה למלאי

### 5.2 גישה ישירה לבסיס הנתונים
- רק מנהלי פרויקט ב-Google Cloud IAM
- דורש אימות דו-שלבי (2FA)
- כל גישה נרשמת ב-Cloud Audit Logs

### 5.3 אין גישה אנונימית
כל בקשה דורשת `request.auth != null` — נאכף ב-Firestore Security Rules.

## 6. גיבוי ושחזור

### 6.1 תדירות גיבוי
- **יומי**: Firestore Automatic Backups
- **רבעוני**: Compliance backup בשבוע הראשון של כל רבעון
- **PITR**: Point-in-Time Recovery — שחזור לכל נקודת זמן

### 6.2 בדיקת שחזור
- **תדירות**: פעם ברבעון
- **תיעוד**: `companies/{companyId}/restore_tests/{testId}`
- **כולל**: הצלחה/כישלון, מספר מסמכים, משך שחזור

### 6.3 תוכנית DR (Disaster Recovery)
1. Firestore Multi-Region replication
2. Quarterly restore tests
3. Documented recovery procedures
4. RTO: < 4 שעות, RPO: < 1 שעה

## 7. מחיקת נתונים

### 7.1 איסור מחיקה
מסמכים חשבונאיים **לא ניתנים למחיקה** — `allow delete: if false` בכל האוספים הרלוונטיים.

### 7.2 לאחר תום תקופת השמירה
- מסמכים שעברו 7 שנים מתום שנת המס — ניתנים לארכוב
- ארכוב = העברה ל-Cold Storage, לא מחיקה
- החלטה על ארכוב — רק על ידי admin, עם רישום ביומן

### 7.3 בקשת מחיקה (GDPR/Privacy)
- נתונים חשבונאיים — לא ניתנים למחיקה לפני תום תקופת השמירה
- נתונים אישיים שאינם חשבונאיים — ניתנים למחיקה לפי בקשה

## 8. בקרה ואכיפה

### 8.1 בדיקות אוטומטיות
- `DataRetentionService.runRetentionCheck()` — בדיקת עמידה במדיניות
- `verifySequentialIntegrity()` — בדיקת פערים במספור
- `IntegrityChainService.verifyChain()` — בדיקת שרשרת שלמות

### 8.2 התראות
- פער במספור → רישום ביומן ביקורת + התראה למנהל
- גיבוי רבעוני חסר → התראה למנהל
- בדיקת שחזור נכשלה → התראה למנהל

### 8.3 עוגנים חיצוניים
- `IntegrityChainService.createAnchor()` — snapshot של hash אחרון
- מומלץ: פעם ברבעון, לפני גיבוי
- ניתן לייצא ל-Cloud Storage / Git / external log
- Anchors exported to external immutable storage (Cloud Storage signed objects)

## 9. אחריות

| תפקיד | אחריות |
|--------|---------|
| מנהל מערכת (admin) | ביצוע גיבויים, בדיקות שחזור, בדיקות retention |
| מפתח ראשי | תחזוקת Rules, עדכוני אבטחה |
| רואה חשבון | אישור מדיניות, ביקורת שנתית |

## 10. עדכון מדיניות

מדיניות זו תיבדק ותעודכן:
- פעם בשנה לפחות
- בכל שינוי חקיקה רלוונטי
- בכל שינוי ארכיטקטורי משמעותי

---

**תאריך אחרון עדכון**: פברואר 2026
**גרסה**: 1.0
