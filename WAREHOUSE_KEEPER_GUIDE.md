# Руководство по работе с системой управления складом

## Роль: Кладовщик (מחסנאי / Warehouse Keeper)

### Создание пользователя-кладовщика

1. Войдите как **Администратор** или **Супер-админ**
2. Перейдите в раздел управления пользователями
3. Нажмите "Добавить пользователя"
4. Заполните данные:
   - Email
   - Пароль
   - Имя
   - **Роль: מחסנאי / Warehouse Keeper**
5. Сохраните

### Функции кладовщика

#### 1. Просмотр инвентаря
- После входа открывается экран "מחסן - ניהול מלאי" (Склад - Управление инвентарём)
- Товары сгруппированы по типам: בביע, מכסה, כוס
- Для каждого товара отображается:
  - Номер и объём (мл)
  - Текущее количество
  - Дата последнего обновления
  - Кто обновил

#### 2. Добавление товара
1. Нажмите кнопку "הוסף מלאי" (Добавить товар)
2. Выберите тип из справочника
3. Выберите номер (автоматически подтянется объём)
4. Введите количество
5. Нажмите "שמור" (Сохранить)

**Если товара нет в справочнике:**
1. Нажмите "הוסף סוג חדש למאגר" (Добавить новый тип в справочник)
2. Введите:
   - Тип (בביע, מכסה, כוס)
   - Номер (100, 200, 300 и т.д.)
   - Объём в мл
3. Сохраните
4. Теперь этот тип доступен для всех

#### 3. Редактирование количества
1. Найдите нужный товар в списке
2. Нажмите иконку редактирования (карандаш)
3. Введите новое количество
4. Сохраните

#### 4. Удаление товара
1. Найдите товар в списке
2. Нажмите иконку удаления (корзина)
3. Подтвердите удаление

### Индикация низких остатков
- Товары с количеством < 10 единиц отмечены **красным цветом**
- Это сигнал для пополнения запасов

---

## Для диспетчеров: Работа с заказами

### Проверка наличия товара
При создании нового заказа:

1. Откройте диалог "הוסף נקודה" (Добавить точку)
2. Заполните данные клиента
3. В разделе "קופסאות" (Коробки) добавьте нужные типы и количество
4. При нажатии "שמור" (Сохранить):
   - **Если товара достаточно** → заказ создаётся, товар списывается
   - **Если товара недостаточно** → появится диалог с предупреждением:
     ```
     אין מספיק מלאי
     לא ניתן ליצור הזמנה - אין מספיק מלאי:
     • בביע 100: נדרש 50, זמין 30
     
     אנא פנה למחסנאי לעדכון המלאי.
     ```
   - Заказ **не будет создан** до пополнения запасов

### Автоматическое списание
- После успешного создания заказа товар **автоматически списывается** со склада
- Кладовщик видит обновлённые остатки в реальном времени
- В истории указывается кто создал заказ

---

## База данных Firebase

### Коллекции

#### `box_types` - Справочник типов коробок
```json
{
  "type": "בביע",
  "number": "100",
  "volumeMl": 250,
  "createdAt": "timestamp"
}
```

#### `inventory` - Инвентарь склада
```json
{
  "type": "בביע",
  "number": "100",
  "volumeMl": 250,
  "quantity": 150,
  "lastUpdated": "timestamp",
  "updatedBy": "Имя пользователя"
}
```

### Правила безопасности
- **Чтение**: все авторизованные пользователи
- **Создание/Обновление**: кладовщик, диспетчер, админ, супер-админ
- **Удаление**: кладовщик, админ, супер-админ

---

## Типичные сценарии

### Сценарий 1: Ежедневная инвентаризация
1. Кладовщик входит в систему
2. Проверяет текущие остатки
3. Обновляет количество по результатам подсчёта
4. Система сохраняет изменения с отметкой времени

### Сценарий 2: Создание заказа с проверкой
1. Диспетчер создаёт заказ на 50 коробок типа "בביע 100"
2. Система проверяет наличие на складе
3. Если есть 50+ единиц → заказ создаётся, списывается 50 единиц
4. Если меньше 50 → показывается предупреждение, заказ блокируется

### Сценарий 3: Пополнение запасов
1. Кладовщик получает новую партию товара
2. Открывает нужный товар в системе
3. Обновляет количество (добавляет к текущему)
4. Теперь диспетчер может создавать заказы

---

## Технические детали

### Файлы системы
- `lib/services/inventory_service.dart` - Сервис управления инвентарём
- `lib/screens/warehouse/warehouse_dashboard.dart` - Экран кладовщика
- `lib/models/inventory_item.dart` - Модель товара
- `firestore.rules` - Правила безопасности

### API методы
- `updateInventory()` - Обновление остатков
- `checkAvailability()` - Проверка доступности
- `deductStock()` - Списание товара
- `getInventoryStream()` - Получение данных в реальном времени

---

## Устранение неполадок

### Ошибка: "Missing or insufficient permissions"
**Решение**: Убедитесь, что правила Firestore задеплоены:
```bash
firebase deploy --only firestore:rules
```

### Товар не отображается в списке
**Решение**: 
1. Проверьте подключение к интернету
2. Обновите страницу (F5)
3. Проверьте, что товар добавлен в коллекцию `inventory`

### Не удаётся создать заказ
**Решение**:
1. Проверьте наличие товара на складе
2. Убедитесь, что количество достаточное
3. Свяжитесь с кладовщиком для пополнения

---

## Контакты и поддержка

При возникновении проблем обращайтесь к администратору системы.

**Версия**: 1.1 (с поддержкой управления складом)
**Дата обновления**: 2026-02-08
