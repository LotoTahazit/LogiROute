rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // â”€â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    function isSuperAdmin() { return userDoc().role == 'super_admin'; }
    function isAdmin()      { return userDoc().role == 'admin'; }
    function isDispatcher() { return userDoc().role == 'dispatcher'; }
    function isDriver()     { return userDoc().role == 'driver'; }
    function inCompany(cId) { return userDoc().companyId == cId; }
    function isAdminOrAbove()      { return isSuperAdmin() || isAdmin(); }
    function isDispatcherOrAbove() { return isSuperAdmin() || isAdmin() || isDispatcher(); }

    // â”€â”€â”€ users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && (
        isSuperAdmin() ||
        (isAdmin() &&
          request.resource.data.companyId == userDoc().companyId &&
          request.resource.data.role in ['dispatcher', 'driver', 'warehouse_keeper'])
      );
      allow update: if request.auth != null && (
        userId == request.auth.uid || isSuperAdmin() ||
        (isAdmin() && resource.data.companyId == userDoc().companyId)
      );
      allow delete: if request.auth != null && (
        isSuperAdmin() ||
        (isAdmin() && resource.data.companyId == userDoc().companyId)
      );
    }

    // â”€â”€â”€ driver_locations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /driver_locations/{driverId} {
      allow read:   if request.auth != null;
      allow write:  if request.auth != null && request.auth.uid == driverId;
      // history subcollection â€” written by AutoCompleteService cleanup
      match /history/{entryId} {
        allow read:   if request.auth != null;
        allow create: if request.auth != null && request.auth.uid == driverId;
        allow delete: if request.auth != null && (
          request.auth.uid == driverId || isAdminOrAbove()
        );
        allow update: if false;
      }
    }

    // â”€â”€â”€ global clients â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /clients/{clientId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && isDispatcherOrAbove();
      allow delete: if request.auth != null && isAdminOrAbove();
    }

    // â”€â”€â”€ routes / truck_routes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /routes/{routeId} {
      allow read:  if request.auth != null;
      allow write: if request.auth != null && isDispatcherOrAbove();
    }
    match /truck_routes/{routeId} {
      allow read:  if request.auth != null;
      allow write: if request.auth != null && isAdminOrAbove();
    }

    // â”€â”€â”€ settings / companySettings / config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /settings/{settingId} {
      allow read:  if request.auth != null;
      allow write: if request.auth != null && isAdminOrAbove();
    }
    match /companySettings/{settingId} {
      allow read:  if request.auth != null;
      allow write: if request.auth != null && isAdminOrAbove();
    }
    match /config/{docId} {
      allow read:  if request.auth != null;
      allow write: if request.auth != null && isAdminOrAbove();
    }

    // â”€â”€â”€ companies + nested collections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /companies/{companyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && isAdminOrAbove();
      allow update, delete: if request.auth != null && isAdminOrAbove();

      match /settings/{settingId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create, update: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow delete: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
      }

      match /product_types/{productTypeId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create, update: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove()));
        allow delete: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
      }

      match /box_types/{boxTypeId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create, update: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && (isAdmin() || isDispatcher() || userDoc().role == 'warehouse_keeper')));
        allow delete: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
      }

      match /clients/{clientId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create, update: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove()));
        allow delete: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
      }

      match /inventory/{inventoryId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create, update: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && (isAdmin() || isDispatcher() || userDoc().role == 'warehouse_keeper')));
        allow delete: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && (isAdmin() || userDoc().role == 'warehouse_keeper')));
      }

      match /prices/{priceId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create, update: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove()));
        allow delete: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
      }

      // ðŸ§¾ invoices â€” immutability per Israeli bookkeeping law
      match /invoices/{invoiceId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove()));
        // update: protect only truly immutable fields after finalization
        allow update: if request.auth != null && (
          isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove())
        ) && (
          !('finalizedAt' in resource.data) ||
          resource.data.finalizedAt == null ||
          (
            request.resource.data.sequentialNumber    == resource.data.sequentialNumber &&
            request.resource.data.companyId           == resource.data.companyId &&
            request.resource.data.clientName          == resource.data.clientName &&
            request.resource.data.clientNumber        == resource.data.clientNumber &&
            request.resource.data.items               == resource.data.items &&
            request.resource.data.discount            == resource.data.discount &&
            request.resource.data.immutableSnapshotHash == resource.data.immutableSnapshotHash &&
            request.resource.data.finalizedAt         == resource.data.finalizedAt &&
            request.resource.data.finalizedBy         == resource.data.finalizedBy
          )
        );
        allow delete: if false;

        // audit log â€” append-only
        match /auditLog/{eventId} {
          allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
          allow create: if request.auth != null &&
            (isSuperAdmin() || inCompany(companyId)) &&
            request.resource.data.actorUid == request.auth.uid;
          allow update, delete: if false;
        }

        // print events â€” append-only
        match /printEvents/{eventId} {
          allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
          allow create: if request.auth != null &&
            (isSuperAdmin() || inCompany(companyId)) &&
            request.resource.data.printedBy == request.auth.uid;
          allow update, delete: if false;
        }
      }

      // assignment requests
      match /assignment_requests/{requestId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove()));
        allow update: if request.auth != null &&
          (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove())) &&
          request.resource.data.invoiceId == resource.data.invoiceId;
        allow delete: if false;
      }

      // delivery points
      match /delivery_points/{pointId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove()));
        allow update: if request.auth != null && (
          isSuperAdmin() ||
          (inCompany(companyId) && isDispatcherOrAbove()) ||
          (isDriver() && resource.data.driverId == request.auth.uid)
        );
        allow delete: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove()));
      }

      // inventory history
      match /inventory_history/{historyId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow update, delete: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
      }

      // counters â€” atomic sequential numbering
      match /counters/{counterId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create: if request.auth != null &&
          (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove())) &&
          request.resource.data.lastNumber == 1;
        allow update: if request.auth != null &&
          (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove())) &&
          request.resource.data.lastNumber == resource.data.lastNumber + 1;
        allow delete: if false;
      }

      // append-only collections
      match /backups/{backupId} {
        allow read: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow create: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow update, delete: if false;
      }
      match /document_links/{linkId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove()));
        allow update, delete: if false;
      }
      match /integrity_chain/{chainId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove()));
        allow update, delete: if false;
      }
      match /integrity_anchors/{anchorId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow update, delete: if false;
      }
      match /uniform_export_runs/{runId} {
        allow read: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow create: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isDispatcherOrAbove()));
        allow update, delete: if false;
      }
      match /access_log/{logId} {
        allow read: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow create: if request.auth != null &&
          (isSuperAdmin() || inCompany(companyId)) &&
          request.resource.data.actorUid == request.auth.uid;
        allow update, delete: if false;
      }
      match /print_templates/{templateId} {
        allow read: if request.auth != null && (isSuperAdmin() || inCompany(companyId));
        allow create, update: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow delete: if false;
      }
      match /retention_checks/{checkId} {
        allow read: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow create: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow update, delete: if false;
      }
      match /restore_tests/{testId} {
        allow read: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow create: if request.auth != null && (isSuperAdmin() || (inCompany(companyId) && isAdmin()));
        allow update, delete: if false;
      }
    } // end /companies/{companyId}

    // â”€â”€â”€ global collections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /bridges/{bridgeId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && isAdminOrAbove();
    }
    match /backups/{backupId} {
      allow read: if request.auth != null && isAdminOrAbove();
      allow create, update, delete: if request.auth != null && isAdminOrAbove();
    }
    match /action_logs/{logId} {
      allow read: if request.auth != null && isAdminOrAbove();
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && isAdminOrAbove();
    }
    match /notifications/{notificationId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (
        isAdminOrAbove() || resource.data.userId == request.auth.uid
      );
    }
    match /il_addresses/{addressId} {
      allow read, write: if request.auth != null;
    }
    match /cached_routes/{routeId} {
      allow read, write: if request.auth != null;
    }
    match /product_templates/{templateId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    match /box_types/{boxTypeId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && (isAdminOrAbove() || isDispatcher() || userDoc().role == 'warehouse_keeper');
      allow delete: if request.auth != null && isAdminOrAbove();
    }
    match /inventory/{inventoryId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && (isAdminOrAbove() || isDispatcher() || userDoc().role == 'warehouse_keeper');
      allow delete: if request.auth != null && (isAdminOrAbove() || userDoc().role == 'warehouse_keeper');
    }
    match /prices/{priceId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && isDispatcherOrAbove();
      allow delete: if request.auth != null && isAdminOrAbove();
    }
    match /invoices/{invoiceId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && isDispatcherOrAbove();
      allow update: if request.auth != null && isDispatcherOrAbove();
      allow delete: if false;
    }
    match /counters/{counterId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isDispatcherOrAbove();
    }
    match /daily_summaries/{summaryId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (isDispatcherOrAbove() || userDoc().role == 'warehouse_keeper');
    }
    match /delivery_summaries/{summaryId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (isDispatcherOrAbove() || isDriver());
    }
    match /inventory_changes/{changeId} {
      allow read, write: if request.auth != null;
    }
    match /inventory_history/{historyId} {
      allow read, write: if request.auth != null;
    }
    match /inventory_counts/{countId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && (isAdminOrAbove() || isDispatcher() || userDoc().role == 'warehouse_keeper');
      allow delete: if request.auth != null && isAdminOrAbove();
    }
    match /archives/{archiveId} {
      allow read: if request.auth != null && isDispatcherOrAbove();
      allow create: if request.auth != null && isAdminOrAbove();
      allow update, delete: if request.auth != null && isAdminOrAbove();
    }

  }
}
