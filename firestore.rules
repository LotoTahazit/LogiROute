rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ‘¥ ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    match /users/{userId} {
      // âœ… Ğ›ÑĞ±Ğ¾Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ· ĞºĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¸ users
      allow read: if request.auth != null;

      // ğŸ”¥ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ: ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow create: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
          request.resource.data.companyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId &&
          request.resource.data.role in ['dispatcher', 'driver', 'warehouse_keeper']
        )
      );

      // ğŸ”¥ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: ÑĞ²Ğ¾Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚, Ğ°Ğ´Ğ¼Ğ¸Ğ½ ÑĞ²Ğ¾ĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow update: if request.auth != null && (
        userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
          resource.data.companyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId
        )
      );

      // ğŸ”¥ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: Ğ°Ğ´Ğ¼Ğ¸Ğ½ ÑĞ²Ğ¾ĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
          resource.data.companyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId
        )
      );
    }

    // ğŸ“ Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ĞµĞ¹ (GPS)
    match /driver_locations/{driverId} {
      allow read: if request.auth != null;
      allow write, create, update: if request.auth != null && request.auth.uid == driverId;
      allow delete: if request.auth != null && request.auth.uid == driverId;
    }

    // ğŸ‘¥ ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹
    match /clients/{clientId} {
      // ğŸ“– Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read: if request.auth != null;

      // âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ/ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: ÑÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½, Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€
      allow create, update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher']
      );

      // âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: ÑÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );
    }

    // ğŸš› ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
    match /routes/{routeId} {
      // ğŸ“– Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ
      allow read: if request.auth != null;

      // âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ: ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½, Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher']
      );
    }

    // ğŸš› Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ·Ğ¾Ğ²Ğ¸ĞºĞ¾Ğ²
    match /truck_routes/{routeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }

    // âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
    match /settings/{settingId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );
    }

    // ğŸ¢ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹ (Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ñ)
    match /companySettings/{settingId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );
    }

    // ğŸ¢ ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
    match /companies/{companyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
      allow update, delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      // ğŸ†• Ğ’Ğ›ĞĞ–Ğ•ĞĞĞ«Ğ• ĞšĞĞ›Ğ›Ğ•ĞšĞ¦Ğ˜Ğ˜ ĞšĞĞœĞŸĞĞĞ˜Ğ˜ - Ğ¡Ğ¢Ğ ĞĞ“Ğ˜Ğ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ
      
      // âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
      match /settings/{settingId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
      }
      
      // ğŸ›ï¸ Ğ¢Ğ¸Ğ¿Ñ‹ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ (product_types)
      match /product_types/{productTypeId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        );
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
      }
      
      // ğŸ“¦ Ğ¢Ğ¸Ğ¿Ñ‹ ĞºĞ¾Ñ€Ğ¾Ğ±Ğ¾Ğº ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
      match /box_types/{boxTypeId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher', 'warehouse_keeper']
          )
        );
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
      }
      
      // ğŸ‘¥ ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
      match /clients/{clientId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        );
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
      }
      
      // ğŸ“¦ Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
      match /inventory/{inventoryId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher', 'warehouse_keeper']
          )
        );
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'warehouse_keeper']
          )
        );
      }
      
      // ğŸ’° Ğ¦ĞµĞ½Ñ‹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
      match /prices/{priceId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        );
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
      }
      
      // ğŸ§¾ Ğ¡Ñ‡ĞµÑ‚Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ (×—×©×‘×•× ×™×•×ª) â€” ×”×’× ×ª ××™-×©×™× ×•×™ ×œ×¤×™ ×—×•×§ × ×™×”×•×œ ×¡×¤×¨×™×
      match /invoices/{invoiceId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        );
        // ×¢×“×›×•×Ÿ: ×× ×”××¡××š ×¢×‘×¨ ×¡×™×•× (finalizedAt != null) â€” ×¨×§ ×©×“×•×ª whitelist
        allow update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        ) && (
          // ××¡××š ×œ× ×¢×‘×¨ ×¡×™×•× â€” × ×™×ª×Ÿ ×œ×¢×“×›×Ÿ ×”×›×œ
          resource.data.finalizedAt == null ||
          // ××¡××š ×¢×‘×¨ ×¡×™×•× â€” ×¨×§ ×©×“×•×ª ××•×ª×¨×™× (whitelist)
          (
            request.resource.data.sequentialNumber == resource.data.sequentialNumber &&
            request.resource.data.companyId == resource.data.companyId &&
            request.resource.data.clientName == resource.data.clientName &&
            request.resource.data.clientNumber == resource.data.clientNumber &&
            request.resource.data.address == resource.data.address &&
            request.resource.data.driverName == resource.data.driverName &&
            request.resource.data.truckNumber == resource.data.truckNumber &&
            request.resource.data.departureTime == resource.data.departureTime &&
            request.resource.data.paymentDueDate == resource.data.paymentDueDate &&
            request.resource.data.items == resource.data.items &&
            request.resource.data.discount == resource.data.discount &&
            request.resource.data.deliveryDate == resource.data.deliveryDate &&
            request.resource.data.createdAt == resource.data.createdAt &&
            request.resource.data.createdBy == resource.data.createdBy &&
            request.resource.data.documentType == resource.data.documentType &&
            request.resource.data.finalizedAt == resource.data.finalizedAt &&
            request.resource.data.finalizedBy == resource.data.finalizedBy &&
            request.resource.data.immutableSnapshotHash == resource.data.immutableSnapshotHash &&
            request.resource.data.linkedInvoiceId == resource.data.linkedInvoiceId
          ) || (
            // âœ… ×¢×“×›×•×Ÿ ×©×“×•×ª ××•×ª×¨×™× ×œ××—×¨ ×¡×™×•×: ×”×§×¦××”, ×”×“×¤×¡×”, ×‘×™×˜×•×œ
            resource.data.finalizedAt != null &&
            request.resource.data.sequentialNumber == resource.data.sequentialNumber &&
            request.resource.data.companyId == resource.data.companyId &&
            request.resource.data.clientName == resource.data.clientName &&
            request.resource.data.items == resource.data.items &&
            request.resource.data.discount == resource.data.discount &&
            request.resource.data.immutableSnapshotHash == resource.data.immutableSnapshotHash &&
            request.resource.data.finalizedAt == resource.data.finalizedAt &&
            request.resource.data.finalizedBy == resource.data.finalizedBy
          )
        );
        // âŒ ××—×™×§×” ××¡×•×¨×” (×—×•×§ × ×™×”×•×œ ×¡×¤×¨×™×)
        allow delete: if false;
        
        // ğŸ“ ×™×•××Ÿ ×‘×™×§×•×¨×ª â€” append-only
        match /auditLog/{eventId} {
          allow read: if request.auth != null && (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
          );
          // ×¨×§ ×™×¦×™×¨×” â€” append-only, actorUid ×—×™×™×‘ ×œ×”×ª××™× ×œ-auth.uid
          allow create: if request.auth != null && (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
          ) && request.resource.data.actorUid == request.auth.uid;
          // âŒ ×¢×“×›×•×Ÿ ×•××—×™×§×” ××¡×•×¨×™× â€” append-only
          allow update: if false;
          allow delete: if false;
        }
        
        // ğŸ–¨ï¸ ××™×¨×•×¢×™ ×”×“×¤×¡×” â€” append-only
        match /printEvents/{eventId} {
          allow read: if request.auth != null && (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
          );
          allow create: if request.auth != null && (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
          ) && request.resource.data.printedBy == request.auth.uid;
          allow update: if false;
          allow delete: if false;
        }
      }
      
      // ğŸ“‹ ×‘×§×©×•×ª ××¡×¤×¨ ×”×§×¦××” â€” append-only + ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
      match /assignment_requests/{requestId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        );
        // ×¢×“×›×•×Ÿ ××•×ª×¨ ×¨×§ ×œ×©×“×•×ª ×¡×˜×˜×•×¡ (×ª×©×•×‘×” ××¨×©×•×ª ×”××¡×™×)
        allow update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        ) && request.resource.data.invoiceId == resource.data.invoiceId;
        allow delete: if false;
      }
      
      // ğŸšš Ğ¢Ğ¾Ñ‡ĞºĞ¸ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ (delivery_points)
      match /delivery_points/{pointId} {
        // ğŸ“– Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ ÑĞ²Ğ¾ĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ + super_admin
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        
        // âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ: super_admin, admin, dispatcher
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        );
        
        // âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: super_admin, admin, dispatcher, Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ²Ğ¾Ğ¸ Ñ‚Ğ¾Ñ‡ĞºĞ¸)
        allow update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          ) ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'driver' &&
            resource.data.driverId == request.auth.uid
          )
        );
        
        // âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: super_admin, admin, dispatcher
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        );
      }
      
      // ğŸ“ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ (inventory_history)
      match /inventory_history/{historyId} {
        // ğŸ“– Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ ÑĞ²Ğ¾ĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ + super_admin
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        
        // âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ ÑĞ²Ğ¾ĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        
        // âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ/Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ super_admin Ğ¸ admin
        allow update, delete: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
          )
        );
      }
      
      // ğŸ”¢ Ğ¡Ñ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ¸ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ â€” ××¡×¤×•×¨ ××˜×•××™, increment == 1 ×‘×œ×‘×“
      match /counters/{counterId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        // ×™×¦×™×¨×”: ×¨×§ ×¢× lastNumber == 1
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        ) && request.resource.data.lastNumber == 1;
        // ×¢×“×›×•×Ÿ: ×¨×§ ×× lastNumber ×¢×•×œ×” ×‘-1 ×‘×“×™×•×§
        allow update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        ) && request.resource.data.lastNumber == resource.data.lastNumber + 1;
        // âŒ ××—×™×§×” ××¡×•×¨×”
        allow delete: if false;
      }
      
      // ğŸ’¾ ×’×™×‘×•×™×™× ×¨×‘×¢×•× ×™×™× (compliance backups)
      match /backups/{backupId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        // âŒ ×¢×“×›×•×Ÿ ×•××—×™×§×” ××¡×•×¨×™× â€” ×¨×©×•××•×ª ×’×™×‘×•×™ ×”×Ÿ append-only
        allow update: if false;
        allow delete: if false;
      }
      
      // ğŸ”— ×§×™×©×•×¨×™× ×‘×™×Ÿ ××¡××›×™× â€” append-only
      match /document_links/{linkId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        );
        allow update: if false;
        allow delete: if false;
      }
      
      // ğŸ”’ ×©×¨×©×¨×ª ×©×œ××•×ª â€” append-only, immutable
      match /integrity_chain/{chainId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        );
        allow update: if false;
        allow delete: if false;
      }
      
      // ğŸ”— ×¢×•×’× ×™× ×—×™×¦×•× ×™×™× ×œ×©×¨×©×¨×ª ×©×œ××•×ª â€” append-only
      match /integrity_anchors/{anchorId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        allow update: if false;
        allow delete: if false;
      }
      
      // ğŸ“Š ×¨×™×¦×•×ª ×™×™×¦×•× ×‘××‘× ×” ××—×™×“ â€” append-only
      match /uniform_export_runs/{runId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dispatcher']
          )
        );
        allow update: if false;
        allow delete: if false;
      }
      
      // ğŸ“‹ ×™×•××Ÿ ×’×™×©×” â€” append-only, SaaS compliance
      match /access_log/{logId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        ) && request.resource.data.actorUid == request.auth.uid;
        allow update: if false;
        allow delete: if false;
      }
      
      // ğŸ–¨ï¸ ×¨×™×©×•× ×’×¨×¡××•×ª ×ª×‘× ×™×•×ª ×”×“×¤×¡×”
      match /print_templates/{templateId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId
        );
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        allow delete: if false;
      }
      
      // ğŸ“… ×‘×“×™×§×•×ª ××“×™× ×™×•×ª ×©××™×¨×” â€” append-only
      match /retention_checks/{checkId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        allow update: if false;
        allow delete: if false;
      }
      
      // ğŸ”„ ×‘×“×™×§×•×ª ×©×—×–×•×¨ â€” append-only
      match /restore_tests/{testId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin']
          )
        );
        allow update: if false;
        allow delete: if false;
      }
    }

    // âš™ï¸ ĞĞ±Ñ‰Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
    match /config/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }

    // ğŸŒ‰ ĞœĞ¾ÑÑ‚Ñ‹
    match /bridges/{bridgeId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }

    // ğŸ’¾ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¿Ğ¸Ğ¸
    match /backups/{backupId} {
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
      allow create, update, delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }

    // ğŸ“ Ğ›Ğ¾Ğ³Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
    match /action_logs/{logId} {
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }

    // ğŸ”” Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
    match /notifications/{notificationId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'] ||
        (resource.data.userId == request.auth.uid)
      );
    }

    // ğŸ“ IL Addresses (ĞºĞµÑˆ Ğ°Ğ´Ñ€ĞµÑĞ¾Ğ²)
    match /il_addresses/{addressId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // ğŸ—ºï¸ Cached routes (ĞºĞµÑˆ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ²)
    match /cached_routes/{routeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // ğŸ“¦ Ğ¢Ğ¸Ğ¿Ñ‹ ĞºĞ¾Ñ€Ğ¾Ğ±Ğ¾Ğº (ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸Ğº)
    match /box_types/{boxTypeId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read: if request.auth != null;

      // âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ/ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€, ĞºĞ»Ğ°Ğ´Ğ¾Ğ²Ñ‰Ğ¸Ğº, Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow create, update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher', 'warehouse_keeper']
      );

      // âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );
    }

    // ğŸ“¦ Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ (ÑĞºĞ»Ğ°Ğ´)
    match /inventory/{inventoryId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read: if request.auth != null;

      // âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ/ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: ĞºĞ»Ğ°Ğ´Ğ¾Ğ²Ñ‰Ğ¸Ğº, Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€, Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow create, update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher', 'warehouse_keeper']
      );

      // âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: ĞºĞ»Ğ°Ğ´Ğ¾Ğ²Ñ‰Ğ¸Ğº, Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'warehouse_keeper']
      );
    }

    // ğŸ’° Ğ¦ĞµĞ½Ñ‹ (Ğ¿Ñ€Ğ°Ğ¹Ñ-Ğ»Ğ¸ÑÑ‚)
    match /prices/{priceId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read: if request.auth != null;

      // âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ/ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€, Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow create, update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher']
      );

      // âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );
    }

    // ğŸ§¾ Ğ¡Ñ‡ĞµÑ‚Ğ° (×—×©×‘×•× ×™×•×ª)
    match /invoices/{invoiceId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read: if request.auth != null;

      // âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ: Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€, Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow create: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher']
      );

      // âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹ ÑÑ‡ĞµÑ‚Ğ¾Ğ² (status, cancelledAt, cancelledBy, cancellationReason)
      allow update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher']
      );

      // âŒ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½Ğ¾ (Israeli tax law compliance)
      allow delete: if false;
    }

    // ğŸ”¢ Ğ¡Ñ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ¸ (Ğ´Ğ»Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ½ÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ÑÑ‡ĞµÑ‚Ğ¾Ğ²)
    match /counters/{counterId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read: if request.auth != null;

      // âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€ĞµĞ· Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ² ĞºĞ¾Ğ´Ğµ (Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€, Ğ°Ğ´Ğ¼Ğ¸Ğ½, ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½)
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher']
      );
    }

    // ğŸ“Š Ğ”Ğ½ĞµĞ²Ğ½Ñ‹Ğµ ÑĞ²Ğ¾Ğ´ĞºĞ¸ (daily summaries)
    match /daily_summaries/{summaryId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read: if request.auth != null;

      // âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ: Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· ĞºĞ¾Ğ´ (Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€, Ğ°Ğ´Ğ¼Ğ¸Ğ½, ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½)
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher', 'warehouse_keeper']
      );
    }

    // ğŸ“Š Ğ¡Ğ²Ğ¾Ğ´ĞºĞ¸ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ¾Ğº (delivery summaries)
    match /delivery_summaries/{summaryId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read: if request.auth != null;

      // âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ: Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· ĞºĞ¾Ğ´ (Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€, Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ, Ğ°Ğ´Ğ¼Ğ¸Ğ½, ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½)
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher', 'driver']
      );
    }

    // ğŸ“ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ñ (inventory changes)
    match /inventory_changes/{changeId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read, write: if request.auth != null;
    }

    // ğŸ“ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ñ (inventory history)
    match /inventory_history/{historyId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read, write: if request.auth != null;
    }

    // ğŸ“Š Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (×¡×¤×™×¨×ª ××œ××™)
    match /inventory_counts/{countId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ²ÑĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
      allow read: if request.auth != null;

      // âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ: ĞºĞ»Ğ°Ğ´Ğ¾Ğ²Ñ‰Ğ¸Ğº, Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€, Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow create: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher', 'warehouse_keeper']
      );

      // âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: ĞºĞ»Ğ°Ğ´Ğ¾Ğ²Ñ‰Ğ¸Ğº (ÑĞ²Ğ¾Ğ¸ Ğ¿Ğ¾Ğ´ÑÑ‡ĞµÑ‚Ñ‹), Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€, Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher', 'warehouse_keeper']
      );

      // âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );
    }

    // ğŸ“¦ ĞÑ€Ñ…Ğ¸Ğ²Ñ‹ (archives metadata)
    match /archives/{archiveId} {
      // âœ… Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ: Ğ°Ğ´Ğ¼Ğ¸Ğ½, Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher']
      );

      // âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€ĞµĞ· Cloud Functions Ğ¸Ğ»Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow create: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );

      // âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ/Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¿ĞµÑ€-Ğ°Ğ´Ğ¼Ğ¸Ğ½
      allow update, delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );
    }
  }
}
