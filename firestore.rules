rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // üë• –ö–æ–ª–ª–µ–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    match /users/{userId} {
      // ‚úÖ –õ—é–±–æ–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users
      allow read: if request.auth != null;

      // üî• –°–æ–∑–¥–∞–Ω–∏–µ: —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω –∏ –∞–¥–º–∏–Ω
      allow create: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
          request.resource.data.companyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId &&
          request.resource.data.role in ['dispatcher', 'driver', 'warehouse_keeper']
        )
      );

      // üî• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: —Å–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç, –∞–¥–º–∏–Ω —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
      allow update: if request.auth != null && (
        userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
          resource.data.companyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId
        )
      );

      // üî• –£–¥–∞–ª–µ–Ω–∏–µ: –∞–¥–º–∏–Ω —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
          resource.data.companyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId
        )
      );
    }

    // üìç –õ–æ–∫–∞—Ü–∏–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π (GPS)
    match /driver_locations/{driverId} {
      allow read: if request.auth != null;
      allow write, create, update: if request.auth != null && request.auth.uid == driverId;
    }

    // üß≠ –¢–æ—á–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
    match /delivery_points/{pointId} {
      // ‚úÖ –ß—Ç–µ–Ω–∏–µ: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –≤—Å–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
      allow read: if request.auth != null;

      // ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ: –¥–∏—Å–ø–µ—Ç—á–µ—Ä, –∞–¥–º–∏–Ω –∏–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
      allow create: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['dispatcher', 'admin']
      );

      // ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –≤–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ç–æ—á–∫–∏; –¥–∏—Å–ø–µ—Ç—á–µ—Ä, –∞–¥–º–∏–Ω –∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω ‚Äî –ª—é–±—ã–µ
      allow update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['dispatcher', 'admin'] ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'driver' &&
          request.auth.uid == resource.data.driverId
        )
      );

      // ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ: –¥–∏—Å–ø–µ—Ç—á–µ—Ä, –∞–¥–º–∏–Ω –∏–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['dispatcher', 'admin']
      );
    }

    // üë• –ö–ª–∏–µ–Ω—Ç—ã
    match /clients/{clientId} {
      // üìñ –ß—Ç–µ–Ω–∏–µ: –≤—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
      allow read: if request.auth != null;

      // ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ/–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω, –∞–¥–º–∏–Ω –∏–ª–∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä
      allow create, update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher']
      );

      // ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ: —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω –∏–ª–∏ –∞–¥–º–∏–Ω
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );
    }

    // üöõ –ú–∞—Ä—à—Ä—É—Ç—ã
    match /routes/{routeId} {
      // üìñ –ß—Ç–µ–Ω–∏–µ: –≤—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ
      allow read: if request.auth != null;

      // ‚úÖ –ó–∞–ø–∏—Å—å: —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω, –∞–¥–º–∏–Ω –∏–ª–∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher']
      );
    }

    // üöõ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –¥–ª—è –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤
    match /truck_routes/{routeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }

    // ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    match /settings/{settingId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );
    }

    // üè¢ –ö–æ–º–ø–∞–Ω–∏–∏
    match /companies/{companyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
      allow update, delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }

    // ‚öôÔ∏è –û–±—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    match /config/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }

    // üåâ –ú–æ—Å—Ç—ã
    match /bridges/{bridgeId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }

    // üíæ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
    match /backups/{backupId} {
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
      allow create, update, delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }

    // üìù –õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π
    match /action_logs/{logId} {
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }

    // üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    match /notifications/{notificationId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin'] ||
        (resource.data.userId == request.auth.uid)
      );
    }

    // üìç IL Addresses (–∫–µ—à –∞–¥—Ä–µ—Å–æ–≤)
    match /il_addresses/{addressId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // üó∫Ô∏è Cached routes (–∫–µ—à –º–∞—Ä—à—Ä—É—Ç–æ–≤)
    match /cached_routes/{routeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // üì¶ –¢–∏–ø—ã –∫–æ—Ä–æ–±–æ–∫ (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫)
    match /box_types/{boxTypeId} {
      // ‚úÖ –ß—Ç–µ–Ω–∏–µ: –≤—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
      allow read: if request.auth != null;

      // ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ/–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –¥–∏—Å–ø–µ—Ç—á–µ—Ä, –∫–ª–∞–¥–æ–≤—â–∏–∫, –∞–¥–º–∏–Ω –∏–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
      allow create, update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher', 'warehouse_keeper']
      );

      // ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ: –∞–¥–º–∏–Ω –∏–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin']
      );
    }

    // üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (—Å–∫–ª–∞–¥)
    match /inventory/{inventoryId} {
      // ‚úÖ –ß—Ç–µ–Ω–∏–µ: –≤—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
      allow read: if request.auth != null;

      // ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ/–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∫–ª–∞–¥–æ–≤—â–∏–∫, –¥–∏—Å–ø–µ—Ç—á–µ—Ä, –∞–¥–º–∏–Ω –∏–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
      allow create, update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'dispatcher', 'warehouse_keeper']
      );

      // ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ: –∫–ª–∞–¥–æ–≤—â–∏–∫, –∞–¥–º–∏–Ω –∏–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super_admin', 'admin', 'warehouse_keeper']
      );
    }
  }
}
