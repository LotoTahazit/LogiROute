rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // Helpers
    // =========================================================
    function signedIn() {
      return request.auth != null;
    }
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    function role() {
      return signedIn() ? userDoc().role : null;
    }
    function isRole(r) {
      return signedIn() && role() == r;
    }
    function hasAnyRole(list) {
      return signedIn() && (role() in list);
    }
    function isSuperAdmin() {
      return isRole('super_admin');
    }
    function isAdminOrAbove() {
      return hasAnyRole(['admin', 'super_admin']);
    }
    function isDispatcherOrAbove() {
      return hasAnyRole(['dispatcher', 'admin', 'super_admin']);
    }

    // membership: user.companyId == companyId (или super_admin)
    function isCompanyMember(companyId) {
      return signedIn() && (isSuperAdmin() || userDoc().companyId == companyId);
    }
    function company(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId)).data;
    }
    function billingActive(companyId) {
      return isCompanyMember(companyId)
        && (company(companyId).billingStatus in ['active', 'trial']);
    }
    function hasModule(companyId, moduleKey) {
      return billingActive(companyId) && company(companyId).modules[moduleKey] == true;
    }
    function canAdminWrite(companyId) {
      return isCompanyMember(companyId) && hasAnyRole(['admin', 'super_admin']);
    }
    function canDispatcherWrite(companyId) {
      return isCompanyMember(companyId) && hasAnyRole(['dispatcher', 'admin', 'super_admin']);
    }
    function canWarehouseWrite(companyId) {
      return isCompanyMember(companyId) && hasAnyRole(['warehouse_keeper', 'admin', 'super_admin']);
    }
    function canDriverWrite(companyId) {
      return isCompanyMember(companyId) && hasAnyRole(['driver', 'dispatcher', 'admin', 'super_admin']);
    }

    // =========================================================
    // Global templates (read-only)
    // =========================================================
    match /product_templates/{templateId} {
      allow read: if signedIn();
      allow write: if false; // только Admin SDK
    }

    // =========================================================
    // Users (global)
    // =========================================================
    match /users/{userId} {
      allow read: if signedIn();
      allow create: if signedIn() && (
        isSuperAdmin() ||
        (isRole('admin') && request.resource.data.companyId == userDoc().companyId)
      );
      allow update: if signedIn() && (
        request.auth.uid == userId ||
        (isRole('admin') && resource.data.companyId == userDoc().companyId) ||
        isSuperAdmin()
      );
      allow delete: if false;
    }

    // =========================================================
    // Driver locations (global, not company-scoped)
    // =========================================================
    match /driver_locations/{driverId} {
      allow read: if signedIn();
      allow write: if signedIn() && request.auth.uid == driverId;
      match /history/{entryId} {
        allow read: if signedIn();
        allow create: if signedIn() && request.auth.uid == driverId;
        allow delete: if signedIn() && (
          request.auth.uid == driverId || isAdminOrAbove()
        );
        allow update: if false;
      }
    }

    // =========================================================
    // Companies root doc
    // =========================================================
    match /companies/{companyId} {
      allow read: if isCompanyMember(companyId);
      allow create: if signedIn() && (isSuperAdmin() || isRole('admin'));
      allow update: if canAdminWrite(companyId);
      allow delete: if false;

      // =========================================================
      // Company settings
      // =========================================================
      match /settings/{docId} {
        allow read: if isCompanyMember(companyId);
        allow create, update: if canAdminWrite(companyId);
        allow delete: if false;
      }

      // Entitlements (если отдельная подколлекция)
      match /entitlements/{docId} {
        allow read: if canAdminWrite(companyId);
        allow create, update: if isSuperAdmin();
        allow delete: if false;
      }

      // =========================================================
      // MODULE: WAREHOUSE — /companies/{c}/warehouse/_root/*
      // =========================================================
      match /warehouse/{document=**} {
        allow read: if hasModule(companyId, 'warehouse');
        allow create, update: if hasModule(companyId, 'warehouse') && canWarehouseWrite(companyId);
        allow delete: if false;
      }

      // =========================================================
      // LOGISTICS — /companies/{c}/logistics/_root/*
      // =========================================================

      // clients: /companies/{c}/logistics/_root/clients/{clientId}
      match /logistics/_root/clients/{clientId} {
        allow read: if isCompanyMember(companyId) && billingActive(companyId) && (
          company(companyId).modules['logistics'] == true ||
          company(companyId).modules['accounting'] == true
        );
        allow create, update: if hasModule(companyId, 'logistics') && canDispatcherWrite(companyId);
        allow delete: if false;
      }

      // delivery_points: /companies/{c}/logistics/_root/delivery_points/{pointId}
      match /logistics/_root/delivery_points/{pointId} {
        allow read: if isCompanyMember(companyId) && billingActive(companyId) && (
          company(companyId).modules['logistics'] == true ||
          company(companyId).modules['dispatcher'] == true
        );
        allow create: if hasModule(companyId, 'logistics') && canDispatcherWrite(companyId);
        allow update: if isCompanyMember(companyId) && billingActive(companyId) && (
          // dispatcher/admin: full update
          (hasModule(companyId, 'logistics') && canDispatcherWrite(companyId)) ||
          // driver: only status-related fields, only assigned point
          (isRole('driver')
            && resource.data.driverId == request.auth.uid
            && request.resource.data.diff(resource.data).changedKeys()
                .hasOnly(['status', 'completedAt', 'autoCompleted', 'updatedByUid', 'updatedAt'])
            && request.resource.data.driverId == resource.data.driverId
            && request.resource.data.driverName == resource.data.driverName
          )
        );
        allow delete: if false;
      }

      // cached_routes: /companies/{c}/logistics/_root/cached_routes/{routeId}
      match /logistics/_root/cached_routes/{routeId} {
        allow read: if isCompanyMember(companyId) && billingActive(companyId);
        allow create, update: if hasModule(companyId, 'logistics') && canDispatcherWrite(companyId);
        allow delete: if hasModule(companyId, 'logistics') && canDispatcherWrite(companyId);
      }

      // prices: /companies/{c}/logistics/_root/prices/{priceId}
      match /logistics/_root/prices/{priceId} {
        allow read: if isCompanyMember(companyId) && billingActive(companyId);
        allow create, update: if hasModule(companyId, 'logistics') && canDispatcherWrite(companyId);
        allow delete: if hasModule(companyId, 'logistics') && canAdminWrite(companyId);
      }

      // =========================================================
      // MODULE: DISPATCHER — /companies/{c}/dispatcher/_root/*
      // =========================================================
      match /dispatcher/{document=**} {
        allow read: if hasModule(companyId, 'dispatcher');
        allow create, update: if hasModule(companyId, 'dispatcher') && canDriverWrite(companyId);
        allow delete: if false;
      }

      // =========================================================
      // MODULE: ACCOUNTING — /companies/{c}/accounting/_root/*
      // (сертифицируемый блок)
      // =========================================================

      // invoices (includes delivery note by documentType:'delivery')
      match /accounting/_root/invoices/{invoiceId} {
        allow read: if hasModule(companyId, 'accounting');
        // create: admin/super_admin any; dispatcher only if documentType == 'delivery'
        allow create: if hasModule(companyId, 'accounting') && isCompanyMember(companyId) && (
          hasAnyRole(['admin', 'super_admin']) ||
          (isRole('dispatcher') && request.resource.data.documentType == 'delivery')
        );
        // update: only admin/super_admin
        allow update: if hasModule(companyId, 'accounting') && canAdminWrite(companyId);
        allow delete: if false;

        // audit log — append-only
        match /auditLog/{eventId} {
          allow read: if hasModule(companyId, 'accounting');
          allow create: if hasModule(companyId, 'accounting') && canAdminWrite(companyId);
          allow update, delete: if false;
        }

        // print events — append-only
        match /printEvents/{eventId} {
          allow read: if hasModule(companyId, 'accounting');
          allow create: if hasModule(companyId, 'accounting') && isCompanyMember(companyId)
            && request.resource.data.printedBy == request.auth.uid;
          allow update, delete: if false;
        }
      }

      // receipts (если отдельная коллекция)
      match /accounting/_root/receipts/{receiptId} {
        allow read: if hasModule(companyId, 'accounting');
        allow create, update: if hasModule(companyId, 'accounting') && canAdminWrite(companyId);
        allow delete: if false;
      }

      // credit notes (если отдельная коллекция)
      match /accounting/_root/credit_notes/{creditId} {
        allow read: if hasModule(companyId, 'accounting');
        allow create, update: if hasModule(companyId, 'accounting') && canAdminWrite(companyId);
        allow delete: if false;
      }

      // counters: строго +1, create nextNumber=1, delete forbidden
      match /accounting/_root/counters/{counterId} {
        allow read: if hasModule(companyId, 'accounting');
        allow create: if hasModule(companyId, 'accounting')
          && canAdminWrite(companyId)
          && request.resource.data.keys().hasOnly(['nextNumber', 'updatedAt', 'updatedBy'])
          && request.resource.data.nextNumber == 1;
        allow update: if hasModule(companyId, 'accounting')
          && canAdminWrite(companyId)
          && request.resource.data.nextNumber == resource.data.nextNumber + 1;
        allow delete: if false;
      }

      // backups
      match /accounting/_root/backups/{backupId} {
        allow read: if hasModule(companyId, 'accounting') && canAdminWrite(companyId);
        allow create: if hasModule(companyId, 'accounting') && canAdminWrite(companyId);
        allow update, delete: if false;
      }

      // integrity/templates/access logs/retention — server-only catch-all
      match /accounting/_root/{secColl}/{docId} {
        allow read: if hasModule(companyId, 'accounting');
        allow write: if false;
      }

      // =========================================================
      // SHARED company-level collections (legacy / non-namespaced)
      // =========================================================
      match /assignment_requests/{requestId} {
        allow read: if isCompanyMember(companyId) && billingActive(companyId);
        allow create: if hasModule(companyId, 'logistics') && canDispatcherWrite(companyId);
        allow update: if canDispatcherWrite(companyId)
          && request.resource.data.invoiceId == resource.data.invoiceId;
        allow delete: if false;
      }

      match /daily_summaries/{summaryId} {
        allow read: if isCompanyMember(companyId);
        allow write: if isCompanyMember(companyId) && (isDispatcherOrAbove() || isRole('warehouse_keeper'));
      }

      match /notifications/{notificationId} {
        allow read: if isCompanyMember(companyId);
        allow create: if isCompanyMember(companyId);
        allow update, delete: if isCompanyMember(companyId) && (
          isAdminOrAbove() || resource.data.userId == request.auth.uid
        );
      }

      // append-only audit/integrity collections
      match /integrity_chain/{chainId} {
        allow read: if isCompanyMember(companyId);
        allow create: if isCompanyMember(companyId) && canDispatcherWrite(companyId);
        allow update, delete: if false;
      }
      match /integrity_anchors/{anchorId} {
        allow read: if isCompanyMember(companyId);
        allow create: if canAdminWrite(companyId);
        allow update, delete: if false;
      }
      match /document_links/{linkId} {
        allow read: if isCompanyMember(companyId);
        allow create: if canDispatcherWrite(companyId);
        allow update, delete: if false;
      }
      match /uniform_export_runs/{runId} {
        allow read: if canAdminWrite(companyId);
        allow create: if canDispatcherWrite(companyId);
        allow update, delete: if false;
      }
      match /access_log/{logId} {
        allow read: if canAdminWrite(companyId);
        allow create: if isCompanyMember(companyId)
          && request.resource.data.actorUid == request.auth.uid;
        allow update, delete: if false;
      }
      match /print_templates/{templateId} {
        allow read: if isCompanyMember(companyId);
        allow create, update: if canAdminWrite(companyId);
        allow delete: if false;
      }
      match /retention_checks/{checkId} {
        allow read: if canAdminWrite(companyId);
        allow create: if canAdminWrite(companyId);
        allow update, delete: if false;
      }
      match /restore_tests/{testId} {
        allow read: if canAdminWrite(companyId);
        allow create: if canAdminWrite(companyId);
        allow update, delete: if false;
      }

    } // end /companies/{companyId}

    // =========================================================
    // Global collections (legacy, backward compat)
    // =========================================================
    match /bridges/{bridgeId} {
      allow read: if signedIn();
      allow create, update, delete: if signedIn() && isAdminOrAbove();
    }
    match /il_addresses/{addressId} {
      allow read, write: if signedIn();
    }
    match /config/{docId} {
      allow read: if signedIn();
      allow write: if signedIn() && isAdminOrAbove();
    }
    match /settings/{settingId} {
      allow read: if signedIn();
      allow write: if signedIn() && isAdminOrAbove();
    }
    match /action_logs/{logId} {
      allow read: if signedIn() && isAdminOrAbove();
      allow create: if signedIn();
      allow update, delete: if signedIn() && isAdminOrAbove();
    }

  }
}
